<!DOCTYPE html>
<html >
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Rui" />



<meta name="description" content="Oracle专家的三次授课。">
<meta name="keywords" content="TimesTen,内存数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="Best Practice">
<meta property="og:url" content="http://blog.guitoubing.top/2018/11/24/Practice/index.html">
<meta property="og:site_name" content="Archer">
<meta property="og:description" content="Oracle专家的三次授课。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://blog.guitoubing.top/img/image-20181124202306595.png">
<meta property="og:image" content="http://blog.guitoubing.top/img/锁.png">
<meta property="og:image" content="http://blog.guitoubing.top/img/锁2.png">
<meta property="og:image" content="http://blog.guitoubing.top/img/image-20181124205409162.png">
<meta property="og:image" content="http://blog.guitoubing.top/img/image-20181126025537963.png">
<meta property="og:updated_time" content="2018-12-05T11:30:20.453Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Best Practice">
<meta name="twitter:description" content="Oracle专家的三次授课。">
<meta name="twitter:image" content="http://blog.guitoubing.top/img/image-20181124202306595.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Archer" type="application/atom+xml">



    <link rel="shortcut icon" href="/bitbug_favicon.icon">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Best Practice | Archer</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>



    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5be07d0c47d59d32"></script>




</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Rui</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:1063932362@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/guitoubing" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/RuiTan" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Coding" href="https://coding.net/u/RuiTan" title="Coding"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dotnet/">Dotnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaFX/">JavaFX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java源码学习之旅/">Java源码学习之旅</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TimesTen/">TimesTen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Win10/">Win10</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/云计算/">云计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存数据库/">内存数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/双系统/">双系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大三上笔记/">大三上笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/引导修复/">引导修复</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/软件工程/">软件工程</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://dinghow.site">Dinghow</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://donggu.me">Donggu</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://github.com/RuiTan">GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">兵痞</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Rui</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Rui</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:1063932362@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/guitoubing" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/RuiTan" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Coding" target="_blank" href="https://coding.net/u/RuiTan" title="Coding"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-Practice" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/11/24/Practice/" class="article-date">
      <time datetime="2018-11-24T06:18:44.000Z" itemprop="datePublished">2018-11-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Best Practice
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/archives/">archives</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TimesTen/">TimesTen</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内存数据库/">内存数据库</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>Oracle专家的三次授课。</p>
</blockquote>
<a id="more"></a>
<h1 id="Lesson-1"><a href="#Lesson-1" class="headerlink" title="Lesson 1"></a>Lesson 1</h1><h2 id="创建用户并分配权限"><a href="#创建用户并分配权限" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建测试schema，命名为test"><a href="#创建测试schema，命名为test" class="headerlink" title="创建测试schema，命名为test"></a>创建测试schema，命名为test</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user test identified by test;</span><br></pre></td></tr></table></figure>
<h3 id="分配连接资源"><a href="#分配连接资源" class="headerlink" title="分配连接资源"></a>分配连接资源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant connect,resource to test;</span><br><span class="line">grant execute on dbms_lock to test;</span><br><span class="line">grant execute on UTL_FILE to test;</span><br></pre></td></tr></table></figure>
<h3 id="为test用户创建external-data目录以及分配权限"><a href="#为test用户创建external-data目录以及分配权限" class="headerlink" title="为test用户创建external_data目录以及分配权限"></a>为test用户创建external_data目录以及分配权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create directory external_data as &apos;/home/oracle/data&apos;;</span><br><span class="line">grant read,write on directory external_data to test;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>要注意oracle用户必须拥有对这里的external_data路径读写的权限。</p>
</blockquote>
<h3 id="分配表空间权限"><a href="#分配表空间权限" class="headerlink" title="分配表空间权限"></a>分配表空间权限</h3><p>我们知道oracle中没有库的概念，取而代之的是表空间（Tablespace），在oracle初次被安装时，数据库中只有系统本身内置的表空间：</p>
<ul>
<li><strong>SYSTEM</strong> - 存储数据字典</li>
<li><strong>SYSAUX</strong> - 存储辅助应用程序的数据</li>
<li><strong>TEMP</strong> - 存储数据库临时对象</li>
<li><strong>USERS</strong> - 存储各个用户创建的对象</li>
<li><strong>UNDOTBS</strong> - 存储不一致数据，用于事物回滚、数据库恢复、读一致性、闪回查询</li>
<li>……</li>
</ul>
<p>而当第一次通过管理员创建一个用户且未为其创建并指定表空间时，数据库系统会为其指定默认的表空间为SYSTEM，而他并没有使用SYSTEM表空间的权限，因此该用户无法完成建表等操作，可通过执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- DBA下执行：</span><br><span class="line">-- 查看数据库中的所有表空间</span><br><span class="line">select * from v$tablespace;</span><br><span class="line">-- 查看当前用户所在的表空间(注意oracle系统表中存储的用户名字段都是大写，要注意这与“oracle中不区分大小写”这一概念区分开来)</span><br><span class="line">select username,default_tablespace from dba_users where username=&apos;TEST&apos;;</span><br><span class="line">-- 为用户赋予当前表空间下的权限</span><br><span class="line">alter user test quota unlimited on users;</span><br><span class="line">--  或者制定用户可用大小：</span><br><span class="line">alter user test quota 50M on users;</span><br></pre></td></tr></table></figure>
<h2 id="连接用户，建表，跑存储过程和函数"><a href="#连接用户，建表，跑存储过程和函数" class="headerlink" title="连接用户，建表，跑存储过程和函数"></a>连接用户，建表，跑存储过程和函数</h2><h3 id="连接test用户"><a href="#连接test用户" class="headerlink" title="连接test用户"></a>连接test用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 在系统命令下连接</span><br><span class="line">cd $ORACLE_HOME/bin</span><br><span class="line">./sqlplus test/test</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 在进入sqlplus后的连接</span><br><span class="line">conn test/test</span><br></pre></td></tr></table></figure>
<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">create table t_mobiles(f_id number(6),f_mobile_head varchar2(50),f_province varchar2(50),f_city varchar2(50),f_platform varchar2(50),f_tel_head varchar2(50),f_zipcode varchar2(50),primary key(f_id));</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_ID IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_MOBILE_HEAD IS &apos;手机号段&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_PROVINCE IS &apos;省份地区&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_CITY IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_PLATFORM IS &apos;运营商&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_TEL_HEAD IS &apos;固话区号&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_ZIPCODE IS &apos;邮政编码&apos;;</span><br><span class="line">COMMENT ON TABLE T_MOBILES  IS &apos;号段表&apos;;</span><br><span class="line"></span><br><span class="line">create table t_records(f_id number(6),f_no varchar2(50),f_begin_time date,f_end_time date,f_duration number(10,0),f_province VARCHAR2(50), f_platform varchar2(50), f_mobile NUMBER(1) DEFAULT -1);</span><br><span class="line">--*注：因f_id导入时缺少数据，所有先不设置为PK.</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_ID IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_NO IS &apos;通话号码&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_BEGIN_TIME IS &apos;开始时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_END_TIME IS &apos;结束时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_DURATION IS &apos;通话时长&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_PROVINCE IS &apos;省份地区&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_PLATFORM IS &apos;运营商&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_MOBILE IS &apos;手机号码标志&apos;;</span><br><span class="line">COMMENT ON TABLE T_RECORDS  IS &apos;通话清单表&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="创建ctl文件导入csv数据"><a href="#创建ctl文件导入csv数据" class="headerlink" title="创建ctl文件导入csv数据"></a>创建ctl文件导入csv数据</h3><p>进入<code>external_data</code>路径下并创建以下文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /home/oracle/data</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi control_mobiles.ctl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi control_records.ctl</span></span><br></pre></td></tr></table></figure>
<p><code>control_mobiles.ctl:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA</span><br><span class="line">CHARACTERSET UTF8</span><br><span class="line">INFILE &apos;/home/oracle/data/mobiles.csv&apos;</span><br><span class="line">TRUNCATE INTO TABLE t_mobiles</span><br><span class="line">FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos;</span><br><span class="line">TRAILING NULLCOLS</span><br><span class="line">(</span><br><span class="line">	F_ID,</span><br><span class="line">	F_MOBILE_HEAD,</span><br><span class="line">	F_PROVINCE,</span><br><span class="line">	F_CITY,</span><br><span class="line">	F_PLATFORM,</span><br><span class="line">	F_TEL_HEAD,</span><br><span class="line">	F_ZIPCODE</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>control_records.ctl:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA</span><br><span class="line">CHARACTERSET UTF8</span><br><span class="line">INFILE &apos;/home/oracle/data/records.csv&apos;</span><br><span class="line">TRUNCATE INTO TABLE t_records</span><br><span class="line">FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos;</span><br><span class="line">TRAILING NULLCOLS</span><br><span class="line">(</span><br><span class="line">	F_NO,</span><br><span class="line">	F_BEGIN_TIME DATE &quot;YYYY-MM-DD HH24:MI:SS&quot;,</span><br><span class="line">	F_END_TIME DATE &quot;YYYY-MM-DD HH24:MI:SS&quot;,</span><br><span class="line">	F_DURATION INTEGER EXTERNAL</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在该路径下执行导入操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$ORACLE_HOME</span>/bin/sqlldr userid=<span class="built_in">test</span>/<span class="built_in">test</span> control=control_mobiles.ctl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$ORACLE_HOME</span>/bin/sqlldr userid=<span class="built_in">test</span>/<span class="built_in">test</span> control=control_records.ctl</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>教程中命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> $ sqlldr userid=<span class="built_in">test</span>/<span class="built_in">test</span>@orcl control=control_mobiles.ctl</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>即在导入时指定<code>连接字符串</code>（这里的orcl实际上是连接字符串的别名），其在<code>$ORACLE_HOME/network/admin/tnsname.ora</code>中被声明，但是默认状态下oracle中并没有配置该连接字符串，意味着我们在连接时不需要为其指定值。</p>
<p>既然如此，应用程序该如何在未进行上述配置的情况下连接到该字符串呢？这里就是<code>连接字符串</code>和<code>服务名</code>的区别，oracle有个默认服务名<code>XE</code>，实际上oracle中还有多个备用服务，当XE服务崩掉的时候会自动切换到备用服务。连接字符串如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; jdbc:oracle:thin:@localhost:1521:XE</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>那么没有配置连接字符串别名时，sqlplus如何通过此方法连接呢？如下直接将连接字符串全部写全：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 命令格式：sqlplus username/password@host:port/service_name</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> $ sqlplus tanrui/tanrui@127.0.0.1:1521/xe</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h2 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-- 1、创建序列seq_records_pk用于生成通话记录表t_records的主键</span><br><span class="line">create sequence seq_records increment by 1 start with 1 ;</span><br><span class="line"></span><br><span class="line">-- 2、修补通话记录表t_records的主键数据，并把f_id改为主键</span><br><span class="line">update t_records set f_id=seq_records.nextval;</span><br><span class="line">alter table t_records add constraint t_records_pk primary key (f_id);</span><br><span class="line"></span><br><span class="line">-- 3、创建并初始化同步锁表，用于多线程同步控制</span><br><span class="line">CREATE TABLE T_LOCK(F_NAME VARCHAR2(30),F_INDEX NUMBER(20,0),PRIMARY KEY(F_NAME));</span><br><span class="line">COMMENT ON COLUMN T_LOCK.F_NAME IS &apos;锁名&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOCK.F_INDEX IS &apos;锁的当前值&apos;;</span><br><span class="line">COMMENT ON TABLE T_LOCK  IS &apos;同步锁表&apos;;</span><br><span class="line">insert into T_LOCK values(&apos;_RECORD_INDEX&apos;,0);</span><br><span class="line"></span><br><span class="line">-- 4、在电话号段表中创建唯一性索引，提高号段检索速度</span><br><span class="line">create unique index uniq_mobile_head on t_mobiles(f_mobile_head);</span><br><span class="line">update t_mobiles set f_province = &apos;内蒙古&apos; where f_province = &apos;内蒙&apos;;</span><br><span class="line"></span><br><span class="line">-- 5、创建日志表，用于记录程序执行过程中的日志信息。</span><br><span class="line">create table t_log(f_time date, f_head varchar2(20), f_content varchar2(500));</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_TIME IS &apos;日志时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_HEAD IS &apos;日志类型标志&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_CONTENT IS &apos;日志内容&apos;;</span><br><span class="line">COMMENT ON TABLE T_LOG  IS &apos;日志表&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="创建函数和存储过程"><a href="#创建函数和存储过程" class="headerlink" title="创建函数和存储过程"></a>创建函数和存储过程</h2><h3 id="声明函数和存储过程"><a href="#声明函数和存储过程" class="headerlink" title="声明函数和存储过程"></a>声明函数和存储过程</h3><ul>
<li>函数is_mobile，判断通话号码是否为手机号码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">--函数：判断通话号码是否为手机号码</span><br><span class="line">CREATE OR REPLACE FUNCTION is_mobile(phone VARCHAR2)</span><br><span class="line">    RETURN BOOLEAN IS</span><br><span class="line"></span><br><span class="line">    v_phone VARCHAR2(20);</span><br><span class="line">    v_head VARCHAR2(2);</span><br><span class="line">BEGIN</span><br><span class="line">    --检查参数func</span><br><span class="line">    IF phone IS NULL THEN</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--去除前后空格</span><br><span class="line">    v_phone := TRIM(phone);</span><br><span class="line"></span><br><span class="line">	--去除号码前面的0</span><br><span class="line">    IF substr(v_phone,0,1) = &apos;0&apos; THEN</span><br><span class="line">        v_phone := substr(v_phone, 2);</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--检查手机号码长度</span><br><span class="line">    IF substr(v_phone,0,1) &lt;&gt; &apos;1&apos; OR LENGTH(v_phone) &lt;&gt; 11 THEN</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--截取号码前两位</span><br><span class="line">    v_head := substr(v_phone,1,2);</span><br><span class="line"></span><br><span class="line">    IF v_head = &apos;13&apos; OR v_head = &apos;14&apos; OR v_head =&apos;15&apos; OR v_head =&apos;17&apos; OR v_head = &apos;18&apos; THEN</span><br><span class="line">        RETURN TRUE;</span><br><span class="line">    ELSE</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程init，清空t_log，同时t_lock置零</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--存储过程：初始化测试数据</span><br><span class="line">CREATE OR REPLACE PROCEDURE init IS</span><br><span class="line">    CURSOR job_cursor IS SELECT JOB FROM user_jobs;</span><br><span class="line">BEGIN</span><br><span class="line">	--重置处理位置为0</span><br><span class="line">    EXECUTE IMMEDIATE &apos;update t_lock set f_index=0&apos;;</span><br><span class="line"></span><br><span class="line">	--清除日志表中的记录</span><br><span class="line">    EXECUTE IMMEDIATE &apos;truncate table t_log&apos;;</span><br><span class="line"></span><br><span class="line">	--重置话单表中的记录</span><br><span class="line">    EXECUTE IMMEDIATE &apos;update t_records set f_province = NULL,f_platform=NULL, f_mobile=-1&apos;;</span><br><span class="line">    COMMIT;</span><br><span class="line"></span><br><span class="line">    FOR tmp_job IN job_cursor LOOP</span><br><span class="line">        dbms_job.broken(tmp_job.JOB,TRUE,sysdate);</span><br><span class="line">        dbms_job.REMOVE(tmp_job.JOB);</span><br><span class="line">    END LOOP;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程print，打印日志，存到T_LOG表中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--存储过程：打印日志</span><br><span class="line">CREATE OR REPLACE PROCEDURE print(prefix VARCHAR2, content VARCHAR2) IS</span><br><span class="line">BEGIN</span><br><span class="line">	--dbms_output.put_line(to_char(&apos;yyyy-mm-dd hh24:mi:ss&apos;)||&apos;,&apos;||prefix||&apos;,&apos;||content);</span><br><span class="line">	INSERT INTO t_log VALUES(sysdate,prefix, content);</span><br><span class="line">	COMMIT;</span><br><span class="line">EXCEPTION</span><br><span class="line">	WHEN OTHERS THEN</span><br><span class="line">		dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">		dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程show，显示当前处理情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--存储过程：显示当前处理情况</span><br><span class="line">CREATE OR REPLACE PROCEDURE show IS</span><br><span class="line">	--待处理记录总数</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line"></span><br><span class="line">	--当前日志表记录总数</span><br><span class="line">    v_log_count NUMBER;</span><br><span class="line"></span><br><span class="line">	--当前数据处理位置</span><br><span class="line">    v_current_index NUMBER;</span><br><span class="line"></span><br><span class="line">	--用户Job表游标</span><br><span class="line">    CURSOR job_cursor IS SELECT * FROM user_jobs;</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">    SELECT COUNT(1) INTO v_log_count FROM t_log;</span><br><span class="line">    SELECT f_index INTO v_current_index FROM t_lock;</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line"></span><br><span class="line">	dbms_output.put_line(&apos;log count: &apos;||v_log_count);</span><br><span class="line">    dbms_output.put_line(&apos;record count: &apos;||v_record_count);</span><br><span class="line">    dbms_output.put_line(&apos;current index: &apos;||v_current_index);</span><br><span class="line"></span><br><span class="line">	--清除用户job记录</span><br><span class="line">    FOR tmp_job IN job_cursor LOOP</span><br><span class="line">        dbms_output.put_line(&apos;job:&apos;||tmp_job.JOB||&apos;,broken:&apos;||tmp_job.broken||&apos;,total_time:&apos;||tmp_job.total_time||&apos;,failures:&apos;||tmp_job.failures||&apos;,interval:&apos;||tmp_job.INTERVAL||&apos;,last_sec:&apos;||tmp_job.last_sec||&apos;,next_sec:&apos;||tmp_job.next_sec);</span><br><span class="line"></span><br><span class="line">    END LOOP;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程process_data，提交一个job处理数据</li>
</ul>
<blockquote>
<p><strong>共享锁和排它锁:</strong></p>
<ul>
<li><p>当某事务对数据添加共享锁时，此时该事务<code>只能读不能写</code>，其他事务只能对该数据添加共享锁，而不能添加排它锁</p>
</li>
<li><p>当某事务对数据添加排它锁时，此时该事务<code>既能读又能写</code>，其他事务不能对该数据添加任何锁</p>
</li>
</ul>
<p><strong>autocommit需要关掉:</strong></p>
<p>假设现在有三个job对T_LOCK表进行并发读写，如下：</p>
<p><img src="/img/image-20181124202306595.png" alt="image-20181124202306595"></p>
<p>步骤如下：</p>
<p><img src="/img/锁.png" alt="锁"></p>
<p>阻塞情况：</p>
<p><img src="/img/锁2.png" alt="锁2"></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">--存储过程：处理数据</span><br><span class="line">CREATE OR REPLACE PROCEDURE process_data(process_no IN NUMBER, batch_size IN NUMBER) IS</span><br><span class="line">    --定义常量</span><br><span class="line">    c_record_index CONSTANT VARCHAR2(20)   :=&apos;_RECORD_INDEX&apos;;</span><br><span class="line">    c_process_prefix CONSTANT VARCHAR2(20) := &apos;[  PROCESS ]&apos;;</span><br><span class="line">    c_select_record_sql VARCHAR2(100)  := &apos;select * from t_records where f_id &gt;= :x and f_id &lt;= :y&apos;;</span><br><span class="line">    c_select_mobile_sql VARCHAR2(100)  := &apos;select * from t_mobiles where f_mobile_head = :x&apos;;</span><br><span class="line">    c_update_mobile_sql VARCHAR2(100)  := &apos;update t_records set f_province = :x, f_platform = :y, f_mobile = 1 where f_id = :z&apos;;</span><br><span class="line">    c_update_record_sql VARCHAR2(100)  := &apos;update t_records set f_mobile = 0 where f_id = :n&apos;;</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line">    v_current_index NUMBER;</span><br><span class="line">    v_begin_index NUMBER;</span><br><span class="line">    v_end_index NUMBER;</span><br><span class="line">    v_id NUMBER;</span><br><span class="line">    v_phone VARCHAR2(20);</span><br><span class="line">    v_province VARCHAR2(20);</span><br><span class="line">    v_platform VARCHAR2(20);</span><br><span class="line">    --定义动态游标</span><br><span class="line">    TYPE ty_record_cursor IS REF CURSOR;</span><br><span class="line">    record_cursor ty_record_cursor;</span><br><span class="line">    mobile_cursor ty_record_cursor;</span><br><span class="line">    v_record_row t_records%rowtype;</span><br><span class="line">    v_mobile_row t_mobiles%rowtype;</span><br><span class="line">BEGIN</span><br><span class="line">    PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], running...&apos;);</span><br><span class="line">    --获取待处理的记录总数</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line">    PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], records count: &apos;||v_record_count);</span><br><span class="line">    LOOP</span><br><span class="line">        --获取记录锁</span><br><span class="line">        SELECT f_index INTO v_current_index FROM t_lock WHERE f_name = c_record_index FOR UPDATE;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], current index: &apos;||v_current_index);</span><br><span class="line">        IF v_current_index = v_record_count THEN</span><br><span class="line">            PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], finished.&apos;);</span><br><span class="line">            EXIT;</span><br><span class="line">        END IF;</span><br><span class="line">        --记录本次处理的开始和结束记录位置</span><br><span class="line">        v_end_index := v_current_index + batch_size;</span><br><span class="line">        IF v_end_index &gt; v_record_count THEN</span><br><span class="line">            v_end_index := v_record_count;</span><br><span class="line">        END IF;</span><br><span class="line">        --提交事务，释放锁</span><br><span class="line">        UPDATE t_lock SET f_index = v_end_index WHERE f_name =c_record_index;</span><br><span class="line">        COMMIT;</span><br><span class="line">        --计算开始位置</span><br><span class="line">        v_begin_index := v_current_index +1;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], begin index:&apos;||v_begin_index||&apos;, end index:&apos;||v_end_index);</span><br><span class="line">        --test：dbms_lock.sleep(5);</span><br><span class="line">        --查询一批记录进行逐个处理</span><br><span class="line">        OPEN record_cursor FOR c_select_record_sql USING v_begin_index, v_end_index;</span><br><span class="line">        LOOP</span><br><span class="line">            FETCH record_cursor INTO v_record_row;</span><br><span class="line">            EXIT WHEN record_cursor%notfound;</span><br><span class="line">            v_id    := v_record_row.f_id;</span><br><span class="line">            v_phone := v_record_row.f_no;</span><br><span class="line">            IF is_mobile(v_phone) THEN</span><br><span class="line">                v_phone := TRIM(v_phone);</span><br><span class="line">                IF substr(v_phone,0,1) = &apos;0&apos; THEN</span><br><span class="line">                    v_phone := substr(v_phone, 2);</span><br><span class="line">                END IF;</span><br><span class="line">                --PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], id:&apos;||v_id||&apos;, phone:&apos;||v_phone);</span><br><span class="line">                --更新话单记录中的省份、运营商以及手机类型标志</span><br><span class="line">                OPEN mobile_cursor FOR c_select_mobile_sql USING substr(v_phone,1,7);</span><br><span class="line">                    FETCH mobile_cursor INTO v_mobile_row;</span><br><span class="line">                    v_province := v_mobile_row.f_province;</span><br><span class="line">                    v_platform := v_mobile_row.f_platform;</span><br><span class="line">                    --FETCH mobile_cursor INTO v_province, v_platform;</span><br><span class="line">                CLOSE mobile_cursor;</span><br><span class="line">				--更新话单记录的运营商、省份地区信息</span><br><span class="line">                EXECUTE IMMEDIATE c_update_mobile_sql USING v_province,v_platform,v_id;</span><br><span class="line">            ELSE</span><br><span class="line">                --更新话单记录为非移动号码类型</span><br><span class="line">                EXECUTE IMMEDIATE c_update_record_sql USING v_id;</span><br><span class="line">            END IF;</span><br><span class="line">			--提交事务</span><br><span class="line">            COMMIT;</span><br><span class="line">        END LOOP;</span><br><span class="line">        CLOSE record_cursor;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], processed index: &apos;||v_end_index);</span><br><span class="line">    END LOOP;</span><br><span class="line">EXCEPTION</span><br><span class="line">    WHEN OTHERS THEN</span><br><span class="line">        dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">        dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程generate_csv_report，生成报表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">--存储过程：生成报表</span><br><span class="line">CREATE OR REPLACE PROCEDURE generate_csv_report IS</span><br><span class="line">	c_report_prefix CONSTANT VARCHAR2(20) := &apos;[  REPORT  ]&apos;;</span><br><span class="line">    v_report_1  UTL_FILE.FILE_TYPE;</span><br><span class="line">    v_report_2  UTL_FILE.FILE_TYPE;</span><br><span class="line">    CURSOR report_1_cursor IS SELECT f_platform,f_province,SUM(f_duration) total FROM t_records WHERE f_mobile=1 GROUP BY f_platform,f_province ORDER BY f_platform ASC,SUM(f_duration) DESC;</span><br><span class="line">    cursor report_2_cursor is select f_province,f_platform,sum(f_duration) total from t_records where f_mobile=1 group by f_province,f_platform order by f_province asc,sum(f_duration) desc;</span><br><span class="line">BEGIN</span><br><span class="line">    --生成报表1，根据运营商分类汇总各省份地区的通话量</span><br><span class="line">    v_report_1 := UTL_FILE.FOPEN( LOCATION =&gt; &apos;EXTERNAL_DATA&apos;, filename =&gt; &apos;report1.csv&apos;, open_mode =&gt; &apos;w&apos;, max_linesize =&gt; 32767);</span><br><span class="line">    FOR cur_tmp IN report_1_cursor LOOP</span><br><span class="line">        UTL_FILE.PUT_LINE(v_report_1, cur_tmp.f_platform || &apos;,&apos; || cur_tmp.f_province || &apos;,&apos; || cur_tmp.total);</span><br><span class="line">    END LOOP;</span><br><span class="line">    UTL_FILE.FCLOSE(v_report_1);</span><br><span class="line">    --生成报表2，根据各省份地区汇总各运营商的通话量</span><br><span class="line">    v_report_2 := UTL_FILE.FOPEN( LOCATION =&gt; &apos;EXTERNAL_DATA&apos;, filename =&gt; &apos;report2.csv&apos;, open_mode =&gt; &apos;w&apos;, max_linesize =&gt; 32767);</span><br><span class="line">    FOR cur_tmp IN report_2_cursor LOOP</span><br><span class="line">        UTL_FILE.PUT_LINE(v_report_2, cur_tmp.f_province || &apos;,&apos; || cur_tmp.f_platform || &apos;,&apos; ||  cur_tmp.total);</span><br><span class="line">    END LOOP;</span><br><span class="line">    UTL_FILE.FCLOSE(v_report_2);</span><br><span class="line">    PRINT(c_report_prefix, &apos;generated reports.&apos;);</span><br><span class="line">    EXCEPTION</span><br><span class="line">        WHEN OTHERS THEN</span><br><span class="line">            dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">            dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程analysis，调用上述函数，完成任务逻辑，支持指定任务个数和一批数量</li>
</ul>
<blockquote>
<p><strong><a href="https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_job.htm#BABHCBFD" target="_blank" rel="noopener">dbms_job</a>:</strong></p>
<p>用于管理job的package</p>
<p><strong>oracle限定的job_queue_processes:</strong></p>
<p>oracle中有一个对任务可启动进程的数量进行限制的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; SQL&gt; show parameter job_queue_processes;</span><br><span class="line">&gt; NAME				     TYPE	 VALUE</span><br><span class="line">&gt; ----------------------------------------------------------</span><br><span class="line">&gt; job_queue_processeses		 integer	 10</span><br><span class="line">&gt;</span><br><span class="line">&gt; SQL&gt; alter system set job_queue_processes=0...1000;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>使用ctrl+c是无法停止job的:</strong></p>
<p>可使用<code>top</code>命令查看当前进程详情，如果需要结束特定job可kill对应job的进程号</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE PROCEDURE analysis (job_count IN NUMBER, batch_size IN NUMBER)IS</span><br><span class="line">    --定义常量</span><br><span class="line">    c_record_index CONSTANT VARCHAR2(20)	:=&apos;_RECORD_INDEX&apos;;</span><br><span class="line">	  c_analysis_prefix CONSTANT VARCHAR2(20)	:= &apos;[ ANALYSIS ]&apos;;</span><br><span class="line">    --当前处理位置</span><br><span class="line">    v_record_index NUMBER;</span><br><span class="line">    --待处理的记录总数</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line">    --保存临时创建的job no</span><br><span class="line">    v_tmp_jobno NUMBER;</span><br><span class="line">    --开始结束时间</span><br><span class="line">    v_begin_time NUMBER;</span><br><span class="line">    v_process_end_time NUMBER;</span><br><span class="line">    v_analysis_end_time NUMBER;</span><br><span class="line">    --异常变量</span><br><span class="line">    e_invalid_input EXCEPTION;</span><br><span class="line">BEGIN</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; start analysis...&apos;);</span><br><span class="line">    --输入参数检查</span><br><span class="line">    IF job_count &lt; 1 OR batch_size&lt;1 THEN</span><br><span class="line">        RAISE e_invalid_input;</span><br><span class="line">    END IF;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; checked input parameters.&apos;);</span><br><span class="line">    --记录开始时间</span><br><span class="line">    v_begin_time := dbms_utility.get_time;</span><br><span class="line">    --获取待处理的记录总数</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; records count: &apos;||v_record_count);</span><br><span class="line">    --开始计算重置为0</span><br><span class="line">    UPDATE t_lock SET f_index=0 WHERE f_name=c_record_index;</span><br><span class="line">    COMMIT;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; reset index to zero.&apos;);</span><br><span class="line">    --提交多个job</span><br><span class="line">    FOR I IN 1.. job_count LOOP</span><br><span class="line">        dbms_job.submit(v_tmp_jobno,&apos;begin process_data(&apos;||I||&apos;,&apos;||batch_size||&apos;); end;&apos;);</span><br><span class="line">        PRINT(c_analysis_prefix, &apos; submitted new job, no: &apos;||v_tmp_jobno);</span><br><span class="line">    END LOOP;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; created &apos;||job_count||&apos; jobs.&apos;);</span><br><span class="line">    --定时检查处理进度</span><br><span class="line">    LOOP</span><br><span class="line">        SELECT f_index INTO v_record_index FROM t_lock WHERE f_name = c_record_index;</span><br><span class="line">        PRINT(c_analysis_prefix, &apos; current index: &apos;||v_record_index);</span><br><span class="line">        IF v_record_index = v_record_count THEN</span><br><span class="line">            PRINT(c_analysis_prefix, &apos; processed all records, exiting...&apos;);</span><br><span class="line">            EXIT;</span><br><span class="line">        ELSE</span><br><span class="line">            dbms_lock.sleep(5);--暂停等待5秒</span><br><span class="line">        END IF;</span><br><span class="line">    END LOOP;</span><br><span class="line">    v_process_end_time := dbms_utility.get_time;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos;process, elapsed time: &apos;||(v_process_end_time-v_begin_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    dbms_output.put_line(&apos;process, elapsed time: &apos;||(v_process_end_time-v_begin_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    --分类汇总产生报表</span><br><span class="line">    generate_csv_report;</span><br><span class="line">    --结束时间</span><br><span class="line">    v_analysis_end_time := dbms_utility.get_time;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos;report, elapsed time: &apos;||(v_analysis_end_time-v_process_end_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    dbms_output.put_line(&apos;report, elapsed time: &apos;||(v_analysis_end_time-v_process_end_time)/100||&apos; seconds.&apos;);</span><br><span class="line">--异常捕获部分</span><br><span class="line">EXCEPTION</span><br><span class="line">    WHEN e_invalid_input THEN</span><br><span class="line">        dbms_output.put_line(&apos;Invalid input values, job_count:&apos;||job_count||&apos;, batch_size:&apos;||batch_size);</span><br><span class="line">    WHEN OTHERS THEN</span><br><span class="line">        dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">        dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程mul_analysis，循环调用analysis，指定不同的任务个数和批数量，并将运行时间存入T_RESULT中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-- 调用多次analysis，指定不同的job数和批数</span><br><span class="line">create or replace procedure mul_analysis is</span><br><span class="line">    -- 最小job数</span><br><span class="line">    v_begin_job_no NUMBER := 3;</span><br><span class="line">    -- 最大job数</span><br><span class="line">    v_end_job_no NUMBER := 8;</span><br><span class="line">    -- 每次增长的batch数量</span><br><span class="line">    v_range NUMBER := 2000;</span><br><span class="line">    -- 最小batch数量</span><br><span class="line">    v_begin_range NUMBER := 1000;</span><br><span class="line">    -- 最大batch数量</span><br><span class="line">    v_end_range NUMBER := 10000;</span><br><span class="line">    -- 当前range</span><br><span class="line">    range NUMBER;</span><br><span class="line">    begin</span><br><span class="line">        for I in v_begin_job_no..v_end_job_no LOOP</span><br><span class="line">            range := v_begin_range;</span><br><span class="line">            LOOP</span><br><span class="line">                -- 清洗表</span><br><span class="line">                init();</span><br><span class="line">                -- 分析</span><br><span class="line">                analysis(I, range);</span><br><span class="line">                range := range+v_range;</span><br><span class="line">				-- range增长到10000则停止</span><br><span class="line">                if range &gt; v_end_range then</span><br><span class="line">                    exit;</span><br><span class="line">                end if;</span><br><span class="line">            end loop;</span><br><span class="line">        end loop;</span><br><span class="line">    end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="执行函数和存储过程"><a href="#执行函数和存储过程" class="headerlink" title="执行函数和存储过程"></a>执行函数和存储过程</h3><blockquote>
<p>在sqlplus中执行函数和存储过程之前需先打开serveroutput，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; SQL&gt; set serveroutput on;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>这是因为存储过程中用到了<code>dbms_output.put_line</code>，上述语句是相当于告诉pl/sql引擎将<code>dbms_output.put_line</code>传递到缓冲区的内容输出到主控制台上。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call init();</span><br><span class="line">call analysis(4,1000);</span><br></pre></td></tr></table></figure>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><p>通过执行<code>mul_analysis()</code>对一系列job和batch组合值进行测试，结果如下：</p>
<p><img src="/img/image-20181124205409162.png" alt="image-20181124205409162"></p>
<h1 id="Lesson-2"><a href="#Lesson-2" class="headerlink" title="Lesson 2"></a>Lesson 2</h1><h2 id="创建用户并分配权限-1"><a href="#创建用户并分配权限-1" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user audittest identified by audittest;</span><br></pre></td></tr></table></figure>
<h3 id="分配权限"><a href="#分配权限" class="headerlink" title="分配权限"></a>分配权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grant connect,resource to audittest;</span><br><span class="line">grant execute on dbms_lock to audittest;</span><br><span class="line">alter user audittest quota unlimited on users;</span><br><span class="line">conn audittest/audittest;</span><br></pre></td></tr></table></figure>
<h2 id="创建表及其他对象"><a href="#创建表及其他对象" class="headerlink" title="创建表及其他对象"></a>创建表及其他对象</h2><h3 id="创建表-1"><a href="#创建表-1" class="headerlink" title="创建表"></a>创建表</h3><blockquote>
<p>注意：</p>
<p>这里在创建表时添加了<code>ENABLE</code>限制条件，oracle中对表和列的约束有<code>Enable</code>/<code>Disable</code>(启用/禁用)和<code>Validate</code>/<code>NoValidate</code>(验证/不验证)</p>
<p>举两个例子：</p>
<p><strong>需更改的错误：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; -- 创建表，对name字段添加唯一性约束</span><br><span class="line">&gt; drop table T_TEST;</span><br><span class="line">&gt; create table T_TEST(</span><br><span class="line">&gt;   id int primary key ,</span><br><span class="line">&gt;   name varchar2(10) constraint unique_name unique disable</span><br><span class="line">&gt; );</span><br><span class="line">&gt; -- 由于某些错误，添加的记录违反了唯一性约束，但添加不会报错</span><br><span class="line">&gt; begin</span><br><span class="line">&gt;   insert into T_TEST values (1, &apos;tan&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (2, &apos;rui&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (3, &apos;tan&apos;);</span><br><span class="line">&gt; end;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt; -- 修改掉违反唯一性约束的值</span><br><span class="line">&gt; update T_TEST set name=&apos;chen&apos; where id=3;</span><br><span class="line">&gt; -- 使得唯一性约束生效</span><br><span class="line">&gt; alter table T_TEST modify constraint unique_name enable;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>需保留的错误：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; -- 创建表，无约束</span><br><span class="line">&gt; drop table T_TEST;</span><br><span class="line">&gt; create table T_TEST(</span><br><span class="line">&gt;   id int primary key ,</span><br><span class="line">&gt;   name varchar2(10)</span><br><span class="line">&gt; );</span><br><span class="line">&gt; -- 一些old的记录本身可能存在重复数据</span><br><span class="line">&gt; begin</span><br><span class="line">&gt;   insert into T_TEST values (1, &apos;tan&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (2, &apos;rui&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (3, &apos;tan&apos;);</span><br><span class="line">&gt; end;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt; -- 对name列创建非唯一性索引</span><br><span class="line">&gt; create index i_name on T_TEST(name);</span><br><span class="line">&gt; -- 新要求需要对name添加唯一性约束unique_name，但保留旧值，注意这里一定要使用非唯一性索引</span><br><span class="line">&gt; alter table T_TEST add constraint unique_name unique(name) using index i_name ENABLE NOVALIDATE ;</span><br><span class="line">&gt; -- 此时无法插入name相同的数据了</span><br><span class="line">&gt; insert into T_TEST values (4, &apos;tan&apos;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">--部门表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line">	&quot;F_MANAGER&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_DEPARTMENT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_CODE&quot; IS &apos;部门编号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_MANAGER&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;  IS &apos;部门表&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_USER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_USER_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_CODE&quot; IS &apos;员工编号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_TELEPHONE&quot; IS &apos;固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_USER&quot;  IS &apos;用户表&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_FULL_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CITY&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_BALANCE&quot; NUMBER(10,2) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARTNER&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_SALESMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DELETED_TAG&quot; NUMBER(1,0) DEFAULT 0 NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_VERSION&quot; NUMBER(6,0) DEFAULT 1 NOT NULL ENABLE,</span><br><span class="line">	 PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CODE&quot; IS &apos;客户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_FULL_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_TELEPHONE&quot; IS &apos;联系固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CITY&quot; IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_BALANCE&quot; IS &apos;余额&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_PARTNER&quot; IS &apos;所属合作伙伴&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_SALESMAN&quot; IS &apos;业务员&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_DELETED_TAG&quot; IS &apos;删除标志，0：可用，1：已删除&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MODIFIED_ID&quot; IS &apos;最后修改人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MODIFIED_TIME&quot; IS &apos;最后修改时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_VERSION&quot; IS &apos;版本号&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;  IS &apos;客户信息表&apos;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_FULL_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CITY&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_BALANCE&quot; NUMBER(10,2) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARTNER&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_SALESMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DELETED_TAG&quot; NUMBER(1,0) DEFAULT 0 NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_VERSION&quot; NUMBER(6,0) DEFAULT 1 NOT NULL ENABLE,</span><br><span class="line">	 CONSTRAINT &quot;T_CUSTOMER_HISTORY_PK&quot; PRIMARY KEY (&quot;F_ID&quot;, &quot;F_VERSION&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">--客户信息历史表</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CODE&quot; IS &apos;客户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_FULL_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_TELEPHONE&quot; IS &apos;联系固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CITY&quot; IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_BALANCE&quot; IS &apos;余额&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_PARTNER&quot; IS &apos;所属合作伙伴&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_SALESMAN&quot; IS &apos;业务员&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_DELETED_TAG&quot; IS &apos;删除标志，0：可用，1：已删除&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MODIFIED_ID&quot; IS &apos;最后修改人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MODIFIED_TIME&quot; IS &apos;最后修改时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_VERSION&quot; IS &apos;版本号&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;  IS &apos;客户信息历史表&apos;;</span><br><span class="line"></span><br><span class="line">--审计表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TABLE_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_ROW_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NEW_VERSION&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_COLUMN_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_OLD_VALUE&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_NEW_VALUE&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_OPERATOR_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_OPERATION_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	 CONSTRAINT &quot;T_AUDIT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_TABLE_NAME&quot; IS &apos;表名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_ROW_ID&quot; IS &apos;业务数据主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_NEW_VERSION&quot; IS &apos;新的版本号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_COLUMN_NAME&quot; IS &apos;字段&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OLD_VALUE&quot; IS &apos;原值&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_NEW_VALUE&quot; IS &apos;新值&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OPERATOR_ID&quot; IS &apos;操作用户&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OPERATION_TIME&quot; IS &apos;操作时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;  IS &apos;审计表&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="创建索引、序列"><a href="#创建索引、序列" class="headerlink" title="创建索引、序列"></a>创建索引、序列</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 创建复合索引</span><br><span class="line">CREATE INDEX &quot;AUDITTEST&quot;.&quot;IDX_TABLE_ROWID&quot; ON &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot; (&quot;F_TABLE_NAME&quot;, &quot;F_ROW_ID&quot;) ;</span><br><span class="line">-- 创建序列</span><br><span class="line">CREATE SEQUENCE  SEQ_AUDIT_PK  INCREMENT BY 1 START WITH 1;</span><br></pre></td></tr></table></figure>
<h3 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">--创建触发器</span><br><span class="line">create or replace trigger trg_customer_audit</span><br><span class="line">before update on t_customer</span><br><span class="line">for each row</span><br><span class="line">declare</span><br><span class="line">    c_insert_sql constant varchar2(100) := &apos;insert into t_audit values(:1,:2,:3,:4,:5,:6,:7,:8,systimestamp)&apos;;</span><br><span class="line">    c_table_name constant varchar2(20)  := &apos;T_CUSTOMER&apos;;</span><br><span class="line">    v_column_name varchar2(20);</span><br><span class="line">begin</span><br><span class="line">    --记录当前数据到历史表</span><br><span class="line">    insert into t_customer_history values(:old.f_id,:old.f_code,:old.f_full_name,:old.f_linkman,:old.f_mobile,:old.f_telephone,:old.f_email,:old.f_address,:old.f_city,:old.f_balance,:old.f_partner,:old.f_remark,:old.f_salesman,:old.f_deleted_tag,:old.f_created_id,:old.f_created_time,:old.f_modified_id,:old.f_modified_time,:old.f_version);</span><br><span class="line"></span><br><span class="line">    --递增记录的版本号</span><br><span class="line">    :new.f_version := :old.f_version+1;</span><br><span class="line"></span><br><span class="line">    --判断字段变化</span><br><span class="line">    if updating(&apos;F_LINKMAN&apos;) then</span><br><span class="line">        v_column_name := &apos;联系人&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_linkman,:new.f_linkman,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_MOBILE&apos;) then</span><br><span class="line">        v_column_name := &apos;手机号码&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_mobile,:new.f_mobile,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_TELEPHONE&apos;) then</span><br><span class="line">        v_column_name := &apos;固定电话&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_telephone,:new.f_telephone,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_EMAIL&apos;) then</span><br><span class="line">        v_column_name := &apos;电子邮箱&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_email,:new.f_email,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_ADDRESS&apos;) then</span><br><span class="line">        v_column_name := &apos;联系地址&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_address,:new.f_address,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_BALANCE&apos;) then</span><br><span class="line">        v_column_name := &apos;余额&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_balance,:new.f_balance,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--创建过程</span><br><span class="line">--过程：重设序列值</span><br><span class="line">create or replace PROCEDURE reset_seq( seq_name IN VARCHAR2 )</span><br><span class="line">IS</span><br><span class="line">    v_val NUMBER;</span><br><span class="line">BEGIN</span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY -&apos; || v_val ||&apos; MINVALUE 0&apos;;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY 1 MINVALUE 0&apos;;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h3><h4 id="过程reset-seq"><a href="#过程reset-seq" class="headerlink" title="过程reset_seq"></a>过程reset_seq</h4><blockquote>
<p>将序列为输入参数seq_name的值重置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--过程：重设序列值</span><br><span class="line">create or replace PROCEDURE reset_seq( seq_name IN VARCHAR2 )</span><br><span class="line">IS</span><br><span class="line">    v_val NUMBER;</span><br><span class="line">BEGIN</span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY -&apos; || v_val ||&apos; MINVALUE 0&apos;;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY 1 MINVALUE 0&apos;;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="过程init"><a href="#过程init" class="headerlink" title="过程init"></a>过程init</h4><blockquote>
<p>truncate(截断)所有表，重设序列，并添加初始值</p>
<p>注意：</p>
<p><strong><code>truncate</code>与<code>delete</code>的区别</strong>：delete通常用于删除表中的某些行或者所有行，且delete支持回滚，删除掉的记录的物理空间在commit前并不会被回收。truncate只能删除表的所有行且不支持回滚，删除掉的记录的物理空间也会被立刻回收。</p>
<p>truncate的好处在于当需要删除所有行它比delete要快，尤其在包含大量触发器、索引和其他依赖项的情况下；且它不会改变表结构、表依赖等关系，这一特性又使得它比重建表更有效，删除和重建表会使得表的依赖关系断开，因此需要重新创建依赖、创建约束、赋予权限等等操作。</p>
<p>但是truncate也有不好的地方，比如说当被truncate的表被依赖时，举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; -- 创建表，f_id字段引用T_TEST的主码id</span><br><span class="line">&gt; drop table T_TEST2;</span><br><span class="line">&gt; create table T_TEST2(</span><br><span class="line">&gt;   id1 int primary key ,</span><br><span class="line">&gt;   f_id int,</span><br><span class="line">&gt;   constraint fk</span><br><span class="line">&gt;   foreign key (f_id)</span><br><span class="line">&gt;     references T_TEST(id) on delete cascade</span><br><span class="line">&gt; );</span><br><span class="line">&gt; select *</span><br><span class="line">&gt; from T_TEST2;</span><br><span class="line">&gt; insert into T_TEST2 values(1, 1);</span><br><span class="line">&gt; -- 可级联删除</span><br><span class="line">&gt; delete from T_TEST;</span><br><span class="line">&gt; -- 将外码置为禁用</span><br><span class="line">&gt; alter table T_TEST2 modify constraint fk disable validate ;</span><br><span class="line">&gt; -- 可截断（当不禁用外码时无法截断）</span><br><span class="line">&gt; truncate table T_TEST;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>可见，可通过禁用约束来完成truncate，但是这些主外键约束应是创建数据库时的我们定义的强制关系，上述方法可能会使得这种强制关系紊乱，因此需做好取舍决策。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">create or replace procedure init is</span><br><span class="line">begin</span><br><span class="line">    --清除数据</span><br><span class="line">    execute immediate &apos;truncate table t_audit&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_customer_history&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_customer&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_user&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_department&apos;;</span><br><span class="line">    --重调序列</span><br><span class="line">    reset_seq(&apos;seq_audit_pk&apos;);</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    insert into t_department values(1,&apos;销售部&apos;,&apos;D01&apos;,NULL,&apos;李明&apos;,&apos;备注1...&apos;);</span><br><span class="line">    insert into t_department values(2,&apos;销售部-北京分部&apos;,&apos;D0101&apos;,1,&apos;赵军&apos;,&apos;备注2...&apos;);</span><br><span class="line">    insert into t_department values(3,&apos;销售部-上海分部&apos;,&apos;D0102&apos;,1,&apos;张华&apos;,&apos;备注3...&apos;);</span><br><span class="line">    insert into t_department values(4,&apos;销售部-深圳分部&apos;,&apos;D0103&apos;,1,&apos;王兵&apos;,&apos;备注4...&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    insert into t_user values(1,1,&apos;仲芳芳&apos;,&apos;U8201&apos;,&apos;女&apos;,&apos;13771234101&apos;,&apos;02131231011&apos;,&apos;use1@samtech.com&apos;,&apos;备注1...&apos;);</span><br><span class="line">    insert into t_user values(2,1,&apos;李明申&apos;,&apos;U8202&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;02131231012&apos;,&apos;use2@samtech.com&apos;,&apos;备注2...&apos;);</span><br><span class="line">    insert into t_user values(3,2,&apos;张雪&apos;, &apos;U8203&apos;,&apos;女&apos;,&apos;13771234103&apos;,&apos;02131231013&apos;,&apos;use3@samtech.com&apos;,&apos;备注3...&apos;);</span><br><span class="line">    insert into t_user values(4,2,&apos;王刚&apos;, &apos;U8204&apos;,&apos;男&apos;,&apos;13771234104&apos;,&apos;02131231014&apos;,&apos;use4@samtech.com&apos;,&apos;备注4...&apos;);</span><br><span class="line">    insert into t_user values(5,3,&apos;赵昌日&apos;,&apos;U8205&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;02131231015&apos;,&apos;use5@samtech.com&apos;,&apos;备注5...&apos;);</span><br><span class="line">    insert into t_user values(6,3,&apos;孙晓华&apos;,&apos;U8206&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;02131231016&apos;,&apos;use6@samtech.com&apos;,&apos;备注6...&apos;);</span><br><span class="line">    insert into t_user values(7,4,&apos;陈亚男&apos;,&apos;U8207&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;02131231017&apos;,&apos;use7@samtech.com&apos;,&apos;备注7...&apos;);</span><br><span class="line">    insert into t_user values(8,4,&apos;刘兵超&apos;,&apos;U8208&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;02131231018&apos;,&apos;use8@samtech.com&apos;,&apos;备注8...&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    insert into t_customer</span><br><span class="line">    values(1,&apos;C1808001&apos;,&apos;上海市永辉电子股份有限公司&apos;,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;02135681589&apos;,&apos;ming@google.com&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;上海市&apos;,12082,&apos;上海中远&apos;,&apos;备注...&apos;,&apos;张娜&apos;,0,1,sysdate,1,sysdate,1);</span><br><span class="line">    commit;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="修改客户信息过程"><a href="#修改客户信息过程" class="headerlink" title="修改客户信息过程"></a>修改客户信息过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">--过程：修改客户地址</span><br><span class="line">create or replace procedure modify_address</span><br><span class="line">(p_row_id in number,p_address in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_address=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_address,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated address successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户余额</span><br><span class="line">create or replace procedure modify_balance</span><br><span class="line">(p_row_id in number,p_balance in number, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_balance=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_balance,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated balance successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户电子邮箱</span><br><span class="line">create or replace procedure modify_email</span><br><span class="line">(p_row_id in number,p_email in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_email=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_email,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated email successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户联系人</span><br><span class="line">create or replace procedure modify_linkman</span><br><span class="line">(p_row_id in number,p_linkman_name in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_linkman=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_linkman_name,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated linkman name successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户联系人信息</span><br><span class="line">create or replace procedure modify_linkman_info</span><br><span class="line">(p_row_id in number,p_linkman_name in varchar2,p_mobile in varchar2,</span><br><span class="line"> p_telephone in varchar2,p_email in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_linkman=:1, f_mobile=:2,</span><br><span class="line">    f_telephone=:3, f_email=:4, f_modified_id=:5, f_modified_time=sysdate where f_id=:6&apos;</span><br><span class="line">    using p_linkman_name,p_mobile,p_telephone,p_email,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated linkman info successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改联系手机</span><br><span class="line">create or replace procedure modify_mobile</span><br><span class="line">(p_row_id in number,p_mobile in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_mobile=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_mobile,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated mobile successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改联系固话</span><br><span class="line">create or replace procedure modify_telephone</span><br><span class="line">(p_row_id in number,p_telephone in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_telephone=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_telephone,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated mobile successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">-- 初始化</span><br><span class="line">call init();</span><br><span class="line"></span><br><span class="line">-- 更改客户信息</span><br><span class="line">begin</span><br><span class="line">	modify_linkman(1,&apos;李明顺&apos;,1);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_mobile(1,&apos;13771083211&apos;,2);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_balance(1,20020,3);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_address(1,&apos;中国上海市嘉定区xxx路&apos;,4);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_email(1,&apos;test1@163.com&apos;,5);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_telephone(1,&apos;02183652145&apos;,6);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_linkman_info(1,&apos;张雨轩&apos;,&apos;15332892301&apos;,&apos;02188881111&apos;,&apos;zhangyx@gmail.com&apos;,7);</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">-- 审计</span><br><span class="line">select * from T_AUDIT;</span><br><span class="line"></span><br><span class="line">-- 回滚客户信息</span><br><span class="line">-- 方法1：</span><br><span class="line">update t_customer a</span><br><span class="line">set(</span><br><span class="line">a.f_full_name,a.f_linkman,a.f_mobile,a.f_telephone,a.f_email,a.f_address,</span><br><span class="line">a.f_city,a.f_balance,a.f_partner,a.f_remark,a.f_salesman,a.f_deleted_tag,</span><br><span class="line">a.f_modified_id,a.f_modified_time</span><br><span class="line">)</span><br><span class="line">=</span><br><span class="line">(</span><br><span class="line">select b.f_full_name,b.f_linkman,b.f_mobile,b.f_telephone,b.f_email,</span><br><span class="line">b.f_address,b.f_city,b.f_balance,b.f_partner,b.f_remark,b.f_salesman,</span><br><span class="line">b.f_deleted_tag,5,sysdate</span><br><span class="line">from t_customer_history b where b.f_id=a.f_id and b.f_version=3</span><br><span class="line">)</span><br><span class="line">where a.f_id=1;</span><br><span class="line">-- 方法2：</span><br><span class="line">merge into t_customer a using t_customer_history b on (a.f_id=1 and a.f_id=b.f_id and b.f_version=3)</span><br><span class="line">when matched then</span><br><span class="line">update set a.f_full_name=b.f_full_name,a.f_linkman=b.f_linkman,a.f_mobile=b.f_mobile,a.f_telephone=b.f_telephone,</span><br><span class="line">a.f_email=b.f_email,a.f_address=b.f_address,a.f_city=b.f_city,a.f_balance=b.f_balance,a.f_partner=b.f_partner,</span><br><span class="line">a.f_remark=b.f_remark,a.f_salesman=b.f_salesman,a.f_deleted_tag=b.f_deleted_tag,a.f_modified_id=5,a.f_modified_time=sysdate;</span><br><span class="line"></span><br><span class="line">-- 查看验证数据</span><br><span class="line">select * from t_customer where f_id=1</span><br><span class="line">union</span><br><span class="line">select * from t_customer_history where f_id=1 and f_version=3;</span><br></pre></td></tr></table></figure>
<h1 id="Lesson-3"><a href="#Lesson-3" class="headerlink" title="Lesson 3"></a>Lesson 3</h1><h2 id="创建用户并分配权限-2"><a href="#创建用户并分配权限-2" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建用户-1"><a href="#创建用户-1" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user permission identified by permission;</span><br></pre></td></tr></table></figure>
<h3 id="分配权限-1"><a href="#分配权限-1" class="headerlink" title="分配权限"></a>分配权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant connect,resource to permission;</span><br><span class="line">alter user permisson quota unlimited on users;</span><br><span class="line">conn permission/permission;</span><br></pre></td></tr></table></figure>
<h2 id="创建表及其他对象-1"><a href="#创建表及其他对象-1" class="headerlink" title="创建表及其他对象"></a>创建表及其他对象</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><blockquote>
<p>方案一在T_CUSTOMER表中存放创建人员ID，以查询该客户的直接负责人，在T_USER表中存放直属领导的ID，用于查询某领导所有下属的客户。</p>
</blockquote>
<h4 id="创建表-2"><a href="#创建表-2" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--方案一</span><br><span class="line">--部门表</span><br><span class="line">CREATE TABLE T_DEPARTMENT</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line">	&quot;F_MANAGER_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_DEPARTMENT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_MANAGER_ID&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_DEPARTMENT&quot;  IS &apos;部门表&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;T_USER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_USER_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_USER&quot;  IS &apos;用户表&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;T_CUSTOMER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	 PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_CUSTOMER&quot;  IS &apos;客户信息表&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="创建过程-1"><a href="#创建过程-1" class="headerlink" title="创建过程"></a>创建过程</h4><h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">CREATE OR REPLACE PROCEDURE INIT IS</span><br><span class="line">BEGIN</span><br><span class="line">    --清除数据</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_CUSTOMER&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_DEPARTMENT&apos;;</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(1,&apos;公司&apos;,NULL,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(2,&apos;行政部&apos;,1,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(3,&apos;销售部&apos;,1,2,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(4,&apos;电销组&apos;,3,3,&apos;销售部电销组&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(5,&apos;推销组&apos;,3,6,&apos;销售部推销组&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    INSERT INTO T_USER VALUES(1,1,&apos;管理员&apos;,&apos;男&apos;,&apos;13771234101&apos;,&apos;USE1@SAMTECH.COM&apos;,&apos;系统管理员&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(2,3,&apos;李明申&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;USE2@SAMTECH.COM&apos;,&apos;销售部经理&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(3,4,&apos;张雪&apos;, &apos;女&apos;,&apos;13771234103&apos;,&apos;USE3@SAMTECH.COM&apos;,&apos;销售部电销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(4,4,&apos;王刚&apos;, &apos;男&apos;,&apos;13771234104&apos;,&apos;USE4@SAMTECH.COM&apos;,&apos;销售部电销组业务员1&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(5,4,&apos;赵昌日&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;USE5@SAMTECH.COM&apos;,&apos;销售部电销组业务员2&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(6,5,&apos;孙晓华&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;USE6@SAMTECH.COM&apos;,&apos;销售部推销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(7,5,&apos;陈亚男&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;USE7@SAMTECH.COM&apos;,&apos;销售部推销组业务员3&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(8,5,&apos;刘兵超&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;USE8@SAMTECH.COM&apos;,&apos;销售部推销组业务员4&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(9,3,&apos;陈彬&apos;,&apos;女&apos;,&apos;13771234109&apos;,&apos;USE9@SAMTECH.COM&apos;,&apos;销售部业务员X1&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(10,3,&apos;王军&apos;,&apos;男&apos;,&apos;13771234110&apos;,&apos;USE10@SAMTECH.COM&apos;,&apos;销售部业务员X2&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(1,&apos;上海市永辉电子股份有限公司&apos;     ,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;MING1@GOOGLE.COM&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;电销组主管创建&apos;,3,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(2,&apos;上海博运汽车销售有限公司&apos;      ,&apos;朱荣荣&apos; ,&apos;13231289212&apos;,&apos;MING2@GOOGLE.COM&apos;,&apos;上海市徐汇区钦江路256号&apos;,&apos;电销组业务员1创建&apos;,4,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(3,&apos;安徽广宏顶管装备制造有限公司&apos;   ,&apos;邱阳阳&apos; ,&apos;15328921231&apos;,&apos;MING3@GOOGLE.COM&apos;,&apos;安徽省广德县经济开发区东纬路5号&apos;,&apos;电销组业务员2创建&apos;,5,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(4,&apos;上海定丰霖贸易有限公司&apos;        ,&apos;赵兰&apos;  ,&apos;15532212322&apos;,&apos;MING4@GOOGLE.COM&apos;,&apos;上海市浦东新区东延路112号408室&apos;,&apos;推销组主管创建&apos;,6,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(5,&apos;上海东俊科技有限公司&apos;          ,&apos;张军&apos;  ,&apos;15367823660&apos;,&apos;MING5@GOOGLE.COM&apos;,&apos;上海市长宁区王安路135号&apos;,&apos;推销组业务员1创建&apos;,7,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(6,&apos;中科创客（深圳）智能工业设备公司&apos;,&apos;李明&apos;  ,&apos;17723180234&apos;,&apos;MING6@GOOGLE.COM&apos;,&apos;深圳市龙岗区富民工业园致康路301号&apos;,&apos;推销组业务员2创建&apos;,8,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(7,&apos;南宁云讯科技有限公司&apos;          ,&apos;王永成&apos;,&apos;13568932166&apos;,&apos;MING7@GOOGLE.COM&apos;,&apos;广东省深圳市福田区长川路102号&apos;,&apos;销售部业务员X1创建&apos;,9,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(8,&apos;沈阳优速家政服务有限公司&apos;       ,&apos;李东升&apos;,&apos;13392312343&apos;,&apos;MING8@GOOGLE.COM&apos;,&apos;辽宁省沈阳市铁西区北二路青年易居东门32号&apos;,&apos;销售部业务员X2创建&apos;,10,SYSDATE);</span><br><span class="line">    COMMIT;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="执行-1"><a href="#执行-1" class="headerlink" title="执行"></a>执行</h4><h5 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set serveroutput on;</span><br><span class="line">exec init;</span><br></pre></td></tr></table></figure>
<h5 id="查询自己的客户"><a href="#查询自己的客户" class="headerlink" title="查询自己的客户"></a>查询自己的客户</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t_customer A WHERE A.f_created_id=&amp;id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&amp;id</code>是所查询人员的ID</p>
</blockquote>
<h5 id="查询某领导下属人员的所有客户"><a href="#查询某领导下属人员的所有客户" class="headerlink" title="查询某领导下属人员的所有客户"></a>查询某领导下属人员的所有客户</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from t_user a  where exists(</span><br><span class="line">SELECT 1 FROM t_department b</span><br><span class="line">WHERE a.f_dept_id=b.f_id and b.f_manager_id=&amp;id</span><br><span class="line">CONNECT BY b.F_PARENT_ID = PRIOR b.F_ID</span><br><span class="line">start with b.F_ID = (select c.f_dept_id from t_user c where c.f_id=&amp;id));</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&amp;id</code>是该领导的ID</p>
</blockquote>
<h4 id="当部门结构或员工归属调整时，权限编码如何处理？"><a href="#当部门结构或员工归属调整时，权限编码如何处理？" class="headerlink" title="当部门结构或员工归属调整时，权限编码如何处理？"></a>当部门结构或员工归属调整时，权限编码如何处理？</h4><p>对于方案一，只需要更改员工直属领导ID即可</p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><blockquote>
<p>方案二取消在T_USER中添加直属领导ID，改为在员工、部门、客户表中添加权限码，查看时直接搜索对应权限码即可</p>
</blockquote>
<h4 id="创建表-3"><a href="#创建表-3" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">--方案二</span><br><span class="line">--部门表</span><br><span class="line">CREATE TABLE T_DEPARTMENT_2</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">    &quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line"> &quot;F_MANAGER_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">  CONSTRAINT &quot;T_DEPARTMENT_PK2&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_CODE&quot; IS &apos;部门编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_MANAGER_ID&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_DEPARTMENT_2&quot;  IS &apos;部门表2&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;T_USER_2&quot;</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">    &quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line"> &quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line"> &quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">  CONSTRAINT &quot;T_USER_PK2&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_CODE&quot; IS &apos;用户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_USER_2&quot;  IS &apos;用户表2&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;T_CUSTOMER_2&quot;</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line"> &quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">    &quot;F_ACCESS_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">  PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ACCESS_CODE&quot; IS &apos;权限编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_CUSTOMER_2&quot;  IS &apos;客户信息表2&apos;;</span><br><span class="line"></span><br><span class="line">-- 创建人员更改历史表</span><br><span class="line">CREATE TABLE T_USER_HISTORY(</span><br><span class="line">  ID NUMBER(6,0) PRIMARY KEY ,</span><br><span class="line">  F_ID NUMBER(6,0) ,</span><br><span class="line">  O_DEP_ID NUMBER(6,0) ,</span><br><span class="line">  O_ACCESS_CODE VARCHAR2(50 BYTE) ,</span><br><span class="line">  N_DEP_ID  NUMBER(6,0),</span><br><span class="line">  N_ACCESS_CODE VARCHAR2(50 BYTE),</span><br><span class="line">  TIME DATE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.ID IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.F_ID IS &apos;修改的人员ID&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.O_DEP_ID IS &apos;旧的部门&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.O_ACCESS_CODE IS &apos;旧的权限&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.N_DEP_ID IS &apos;新的部门&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.N_ACCESS_CODE IS &apos;新的权限&apos;;</span><br><span class="line">COMMENT ON TABLE T_USER_HISTORY IS &apos;用户权限更改历史&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="创建过程-2"><a href="#创建过程-2" class="headerlink" title="创建过程"></a>创建过程</h4><h5 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">CREATE OR REPLACE PROCEDURE INIT2 IS</span><br><span class="line">BEGIN</span><br><span class="line">    --清除数据</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_CUSTOMER_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_DEPARTMENT_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER_HISTORY&apos;;</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(1,&apos;公司&apos;,&apos;1&apos;,NULL,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(2,&apos;行政部&apos;,&apos;101&apos;,1,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(3,&apos;销售部&apos;,&apos;102&apos;,1,2,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(4,&apos;电销组&apos;,&apos;10201&apos;,3,3,&apos;销售部电销组&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(5,&apos;推销组&apos;,&apos;10202&apos;,3,6,&apos;销售部推销组&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(1,1,&apos;管理员&apos;,&apos;1&apos;,&apos;男&apos;,&apos;13771234101&apos;,&apos;USE1@SAMTECH.COM&apos;,&apos;系统管理员&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(2,3,&apos;李明申&apos;,&apos;102&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;USE2@SAMTECH.COM&apos;,&apos;销售部经理&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(3,4,&apos;张雪&apos;,  &apos;10201&apos;, &apos;女&apos;,&apos;13771234103&apos;,&apos;USE3@SAMTECH.COM&apos;,&apos;销售部电销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(4,4,&apos;王刚&apos;,  &apos;1020101&apos;, &apos;男&apos;,&apos;13771234104&apos;,&apos;USE4@SAMTECH.COM&apos;,&apos;销售部电销组业务员1&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(5,4,&apos;赵昌日&apos;,&apos;1020102&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;USE5@SAMTECH.COM&apos;,&apos;销售部电销组业务员2&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(6,5,&apos;孙晓华&apos;,&apos;10202&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;USE6@SAMTECH.COM&apos;,&apos;销售部推销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(7,5,&apos;陈亚男&apos;,&apos;1020201&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;USE7@SAMTECH.COM&apos;,&apos;销售部推销组业务员3&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(8,5,&apos;刘兵超&apos;,&apos;1020202&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;USE8@SAMTECH.COM&apos;,&apos;销售部推销组业务员4&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(9,3,&apos;陈彬&apos;,  &apos;10203&apos;,&apos;女&apos;,&apos;13771234109&apos;,&apos;USE9@SAMTECH.COM&apos;,&apos;销售部业务员X1&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(10,3,&apos;王军&apos;, &apos;10204&apos;,&apos;男&apos;,&apos;13771234110&apos;,&apos;USE10@SAMTECH.COM&apos;,&apos;销售部业务员X2&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(1,&apos;上海市永辉电子股份有限公司&apos;     ,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;MING1@GOOGLE.COM&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;电销组主管创建&apos;,&apos;10201&apos;,3,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(2,&apos;上海博运汽车销售有限公司&apos;      ,&apos;朱荣荣&apos; ,&apos;13231289212&apos;,&apos;MING2@GOOGLE.COM&apos;,&apos;上海市徐汇区钦江路256号&apos;,&apos;电销组业务员1创建&apos;,&apos;1020101&apos;,4,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(3,&apos;安徽广宏顶管装备制造有限公司&apos;   ,&apos;邱阳阳&apos; ,&apos;15328921231&apos;,&apos;MING3@GOOGLE.COM&apos;,&apos;安徽省广德县经济开发区东纬路5号&apos;,&apos;电销组业务员2创建&apos;,&apos;1020102&apos;,5,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(4,&apos;上海定丰霖贸易有限公司&apos;        ,&apos;赵兰&apos;  ,&apos;15532212322&apos;,&apos;MING4@GOOGLE.COM&apos;,&apos;上海市浦东新区东延路112号408室&apos;,&apos;推销组主管创建&apos;,&apos;10202&apos;,6,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(5,&apos;上海东俊科技有限公司&apos;          ,&apos;张军&apos;  ,&apos;15367823660&apos;,&apos;MING5@GOOGLE.COM&apos;,&apos;上海市长宁区王安路135号&apos;,&apos;推销组业务员1创建&apos;,&apos;1020201&apos;,7,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(6,&apos;中科创客（深圳）智能工业设备公司&apos;,&apos;李明&apos;  ,&apos;17723180234&apos;,&apos;MING6@GOOGLE.COM&apos;,&apos;深圳市龙岗区富民工业园致康路301号&apos;,&apos;推销组业务员2创建&apos;,&apos;1020202&apos;,8,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(7,&apos;南宁云讯科技有限公司&apos;          ,&apos;王永成&apos;,&apos;13568932166&apos;,&apos;MING7@GOOGLE.COM&apos;,&apos;广东省深圳市福田区长川路102号&apos;,&apos;销售部业务员X1创建&apos;,&apos;10203&apos;,9,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(8,&apos;沈阳优速家政服务有限公司&apos;       ,&apos;李东升&apos;,&apos;13392312343&apos;,&apos;MING8@GOOGLE.COM&apos;,&apos;辽宁省沈阳市铁西区北二路青年易居东门32号&apos;,&apos;销售部业务员X2创建&apos;,&apos;10204&apos;,10,SYSDATE);</span><br><span class="line">    COMMIT;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h5 id="将某员工调换到某部门"><a href="#将某员工调换到某部门" class="headerlink" title="将某员工调换到某部门"></a>将某员工调换到某部门</h5><p><img src="/img/image-20181126025537963.png" alt="image-20181126025537963"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">-- 更改用户到特定部门</span><br><span class="line">CREATE OR REPLACE PROCEDURE CHANGE_TO_DEPARTMENT(C_F_ID IN T_USER_2.F_ID%TYPE, N_DEP_ID IN T_DEPARTMENT_2.F_ID%TYPE) IS</span><br><span class="line">  -- 旧部门</span><br><span class="line">  O_DEP_ID T_DEPARTMENT_2.F_ID%TYPE;</span><br><span class="line">  -- 旧权限</span><br><span class="line">  O_ACCESS_CODE T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 部门权限前缀</span><br><span class="line">  DEP_ACCESS_CODE_PREFIX T_DEPARTMENT_2.F_CODE%TYPE;</span><br><span class="line">  -- 部门当前人数</span><br><span class="line">  DEP_USER_COUNT T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 本部门下的部门数</span><br><span class="line">  DEP_DEP_COUNT T_DEPARTMENT_2.F_CODE%TYPE;</span><br><span class="line">  -- 新权限</span><br><span class="line">  N_ACCESS_CODE T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 更新该员工权限</span><br><span class="line">  C_UPDATE_USER VARCHAR2(100) := &apos;UPDATE T_USER_2 SET F_CODE = :1, F_DEPT_ID = :2 WHERE F_ID = :3&apos;;</span><br><span class="line">  -- 更新所有该员工的客户的ACCESS权限</span><br><span class="line">  C_UPDATE_CUSTOMER VARCHAR2(100) := &apos;UPDATE T_CUSTOMER_2 SET F_ACCESS_CODE = :1 WHERE F_CREATED_ID = :2&apos;;</span><br><span class="line">  -- 插入一条修改记录</span><br><span class="line">  C_INSERT_HISTORY VARCHAR2(100) := &apos;INSERT INTO T_USER_HISTORY VALUES (:1, :2, :3, :4, :5, :6, :7)&apos;;</span><br><span class="line">  BEGIN</span><br><span class="line">    -- 旧部门</span><br><span class="line">    SELECT F_DEPT_ID INTO O_DEP_ID FROM T_USER_2 WHERE T_USER_2.F_ID=C_F_ID;</span><br><span class="line">    -- 旧权限</span><br><span class="line">    SELECT F_CODE INTO O_ACCESS_CODE FROM T_USER_2 WHERE T_USER_2.F_ID=C_F_ID;</span><br><span class="line">    -- 新部门权限作为前缀</span><br><span class="line">    SELECT F_CODE INTO DEP_ACCESS_CODE_PREFIX FROM T_DEPARTMENT_2 WHERE T_DEPARTMENT_2.F_ID = N_DEP_ID;</span><br><span class="line">    -- 计算该部门人员数量</span><br><span class="line">    SELECT MAX(T_USER_2.F_CODE) INTO DEP_USER_COUNT FROM T_USER_2 WHERE T_USER_2.F_DEPT_ID = N_DEP_ID;</span><br><span class="line">    -- 计算子部门数量</span><br><span class="line">    SELECT MAX(T_DEPARTMENT_2.F_CODE) INTO DEP_DEP_COUNT FROM T_DEPARTMENT_2 WHERE SUBSTR(T_DEPARTMENT_2.F_CODE, 0, LENGTH(DEP_ACCESS_CODE_PREFIX))=DEP_ACCESS_CODE_PREFIX AND LENGTH(T_DEPARTMENT_2.F_CODE)=LENGTH(DEP_ACCESS_CODE_PREFIX)+2;</span><br><span class="line">    -- 若新部门与旧部门相同，无需更改</span><br><span class="line">    IF N_DEP_ID=O_DEP_ID THEN</span><br><span class="line">      RETURN;</span><br><span class="line">    END IF;</span><br><span class="line">    -- 新权限CODE</span><br><span class="line">    IF DEP_DEP_COUNT &gt; DEP_USER_COUNT THEN</span><br><span class="line">      N_ACCESS_CODE := TO_CHAR(TO_NUMBER(DEP_DEP_COUNT) + 1);</span><br><span class="line">    ELSE</span><br><span class="line">      N_ACCESS_CODE := TO_CHAR(TO_NUMBER(DEP_USER_COUNT) + 1);</span><br><span class="line">    end if;</span><br><span class="line">    -- 输出相关变量</span><br><span class="line">    dbms_output.put_line(&apos;DEP_USER_COUNT : &apos; || DEP_USER_COUNT);</span><br><span class="line">    dbms_output.put_line(&apos;DEP_DEP_COUNT : &apos; || DEP_DEP_COUNT);</span><br><span class="line">    -- 输出相关变量</span><br><span class="line">    dbms_output.put_line(&apos;DEP_ACCESS_CODE_PREFIX : &apos; || DEP_ACCESS_CODE_PREFIX);</span><br><span class="line">    dbms_output.put_line(&apos;C_F_ID : &apos; || C_F_ID);</span><br><span class="line">    dbms_output.put_line(&apos;O_ACCESS_CODE : &apos; || O_ACCESS_CODE);</span><br><span class="line">    dbms_output.put_line(&apos;N_DEP_ID : &apos; || N_DEP_ID);</span><br><span class="line">    dbms_output.put_line(&apos;N_ACCESS_CODE : &apos; || N_ACCESS_CODE);</span><br><span class="line">    -- 更新该员工权限</span><br><span class="line">    EXECUTE IMMEDIATE C_UPDATE_USER USING N_ACCESS_CODE, N_DEP_ID, C_F_ID;</span><br><span class="line">    -- 更新所有该员工的客户的ACCESS权限</span><br><span class="line">    EXECUTE IMMEDIATE C_UPDATE_CUSTOMER USING N_ACCESS_CODE, C_F_ID;</span><br><span class="line">    -- 插入一条修改记录</span><br><span class="line">    EXECUTE IMMEDIATE C_INSERT_HISTORY USING USER_HISTORY.NEXTVAL, C_F_ID, O_DEP_ID, O_ACCESS_CODE, N_DEP_ID, N_ACCESS_CODE, SYSDATE;</span><br><span class="line">    -- 提交</span><br><span class="line">    COMMIT;</span><br><span class="line">  END;</span><br><span class="line">  /</span><br></pre></td></tr></table></figure>
<h4 id="创建序列"><a href="#创建序列" class="headerlink" title="创建序列"></a>创建序列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 员工部门历史记录主码序列</span><br><span class="line">CREATE SEQUENCE USER_HISTORY INCREMENT BY 1 START WITH 1;</span><br></pre></td></tr></table></figure>
<h4 id="执行-2"><a href="#执行-2" class="headerlink" title="执行"></a>执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_customer_2 where f_access_code like &apos;xxx%&apos;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>xxx%</code>指匹配所有以<code>xxx</code>开头的权限码</p>
</blockquote>
<h4 id="当部门结构或员工归属调整时，权限编码如何处理？-1"><a href="#当部门结构或员工归属调整时，权限编码如何处理？-1" class="headerlink" title="当部门结构或员工归属调整时，权限编码如何处理？"></a>当部门结构或员工归属调整时，权限编码如何处理？</h4><p>方案二中，调用新增的过程<code>CHANGE_TO_DEPARTMENT</code>即可级联更改权限码。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/11/24/Practice/">Best Practice</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Rui</a></p>
        <p><span>发布时间:</span>2018-11-24, 14:18:44</p>
        <p><span>最后更新:</span>2018-12-05, 19:30:20</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/11/24/Practice/" title="Best Practice">http://blog.guitoubing.top/2018/11/24/Practice/</a>
            <span class="copy-path" data-clipboard-text="原文: http://blog.guitoubing.top/2018/11/24/Practice/　　作者: Rui" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/12/12/Hadoop-Tags/">
                    Hadoop-Tags
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/11/12/使用Docker安装Oracle-12c/">
                    感谢Docker,让我远离环境配置
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lesson-1"><span class="toc-number">1.</span> <span class="toc-text">Lesson 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建用户并分配权限"><span class="toc-number">1.1.</span> <span class="toc-text">创建用户并分配权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建测试schema，命名为test"><span class="toc-number">1.1.1.</span> <span class="toc-text">创建测试schema，命名为test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分配连接资源"><span class="toc-number">1.1.2.</span> <span class="toc-text">分配连接资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为test用户创建external-data目录以及分配权限"><span class="toc-number">1.1.3.</span> <span class="toc-text">为test用户创建external_data目录以及分配权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分配表空间权限"><span class="toc-number">1.1.4.</span> <span class="toc-text">分配表空间权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接用户，建表，跑存储过程和函数"><span class="toc-number">1.2.</span> <span class="toc-text">连接用户，建表，跑存储过程和函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#连接test用户"><span class="toc-number">1.2.1.</span> <span class="toc-text">连接test用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建表"><span class="toc-number">1.2.2.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建ctl文件导入csv数据"><span class="toc-number">1.2.3.</span> <span class="toc-text">创建ctl文件导入csv数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据预处理"><span class="toc-number">1.3.</span> <span class="toc-text">数据预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建函数和存储过程"><span class="toc-number">1.4.</span> <span class="toc-text">创建函数和存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#声明函数和存储过程"><span class="toc-number">1.4.1.</span> <span class="toc-text">声明函数和存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行函数和存储过程"><span class="toc-number">1.4.2.</span> <span class="toc-text">执行函数和存储过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结果分析"><span class="toc-number">1.5.</span> <span class="toc-text">结果分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lesson-2"><span class="toc-number">2.</span> <span class="toc-text">Lesson 2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建用户并分配权限-1"><span class="toc-number">2.1.</span> <span class="toc-text">创建用户并分配权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建用户"><span class="toc-number">2.1.1.</span> <span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分配权限"><span class="toc-number">2.1.2.</span> <span class="toc-text">分配权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建表及其他对象"><span class="toc-number">2.2.</span> <span class="toc-text">创建表及其他对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建表-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建索引、序列"><span class="toc-number">2.2.2.</span> <span class="toc-text">创建索引、序列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建触发器"><span class="toc-number">2.2.3.</span> <span class="toc-text">创建触发器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建过程"><span class="toc-number">2.2.4.</span> <span class="toc-text">创建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#过程reset-seq"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">过程reset_seq</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#过程init"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">过程init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改客户信息过程"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">修改客户信息过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行"><span class="toc-number">2.2.5.</span> <span class="toc-text">执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lesson-3"><span class="toc-number">3.</span> <span class="toc-text">Lesson 3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建用户并分配权限-2"><span class="toc-number">3.1.</span> <span class="toc-text">创建用户并分配权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建用户-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分配权限-1"><span class="toc-number">3.1.2.</span> <span class="toc-text">分配权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建表及其他对象-1"><span class="toc-number">3.2.</span> <span class="toc-text">创建表及其他对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方案一"><span class="toc-number">3.2.1.</span> <span class="toc-text">方案一</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建表-2"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建过程-1"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">创建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#初始化"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">初始化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行-1"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">执行</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#初始化-1"><span class="toc-number">3.2.1.3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查询自己的客户"><span class="toc-number">3.2.1.3.2.</span> <span class="toc-text">查询自己的客户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查询某领导下属人员的所有客户"><span class="toc-number">3.2.1.3.3.</span> <span class="toc-text">查询某领导下属人员的所有客户</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#当部门结构或员工归属调整时，权限编码如何处理？"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">当部门结构或员工归属调整时，权限编码如何处理？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案二"><span class="toc-number">3.2.2.</span> <span class="toc-text">方案二</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建表-3"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建过程-2"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">创建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#初始化-2"><span class="toc-number">3.2.2.2.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#将某员工调换到某部门"><span class="toc-number">3.2.2.2.2.</span> <span class="toc-text">将某员工调换到某部门</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建序列"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">创建序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行-2"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#当部门结构或员工归属调整时，权限编码如何处理？-1"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">当部门结构或员工归属调整时，权限编码如何处理？</span></a></li></ol></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Best Practice　| Archer　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
        <div class="addthis_sharing_toolbox"></div>
    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = 'http://blog.guitoubing.top/2018/11/24/Practice/';
            this.page.identifier = '2018/11/24/Practice/';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//guitoubing-top.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

</section>


    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/12/12/Hadoop-Tags/" title="上一篇: Hadoop-Tags">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/11/12/使用Docker安装Oracle-12c/" title="下一篇: 感谢Docker,让我远离环境配置">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/Hadoop-Tags/">Hadoop-Tags</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/Practice/">Best Practice</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/使用Docker安装Oracle-12c/">感谢Docker,让我远离环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/记一次Win10-Fedora双系统的小折腾/">记一次Win10+Fedora双系统的小折腾</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/28/JavaFX-学习小记/">JavaFX 学习小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/02/TimesTen内存数据库课程笔记/">TimesTen内存数据库课程笔记（更新中）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/软件工程课程笔记/">软件工程课程笔记（更新中）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/计算机网络课程笔记/">计算机网络课程笔记（更新中）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/26/Dotnet/">dotnet基本配置及EFCore连接Mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/26/2017-10-14/">我们梦中见</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2017-2018 Rui
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-108090005-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*)" + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>