<!DOCTYPE html>
<html lang="en,zh-cn,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://blog.guitoubing.top').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.json',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Oracle专家的三次授课。">
<meta name="keywords" content="TimesTen,内存数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="内存数据库 - Best Practice">
<meta property="og:url" content="http://blog.guitoubing.top/2018/11/24/Practice/index.html">
<meta property="og:site_name" content="鬼头兵">
<meta property="og:description" content="Oracle专家的三次授课。">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.guitoubing.top/images/image-20181124202306595.png">
<meta property="og:image" content="http://blog.guitoubing.top/images/锁.png">
<meta property="og:image" content="http://blog.guitoubing.top/images/锁2.png">
<meta property="og:image" content="http://blog.guitoubing.top/images/image-20181124205409162.png">
<meta property="og:image" content="http://blog.guitoubing.top/images/image-20181126025537963.png">
<meta property="og:updated_time" content="2019-12-13T06:08:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="内存数据库 - Best Practice">
<meta name="twitter:description" content="Oracle专家的三次授课。">
<meta name="twitter:image" content="http://blog.guitoubing.top/images/image-20181124202306595.png">

<link rel="canonical" href="http://blog.guitoubing.top/2018/11/24/Practice/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>内存数据库 - Best Practice | 鬼头兵</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-108090005-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-108090005-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">鬼头兵</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">人生苦短，几十岁了还不行乐？</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>Sitemap</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/ruitan" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.guitoubing.top/2018/11/24/Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.png">
      <meta itemprop="name" content="Rui">
      <meta itemprop="description" content="我们梦中见！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鬼头兵">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          内存数据库 - Best Practice
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-24 14:18:44" itemprop="dateCreated datePublished" datetime="2018-11-24T14:18:44+08:00">2018-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-13 14:08:19" itemprop="dateModified" datetime="2019-12-13T14:08:19+08:00">2019-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>Oracle专家的三次授课。</p>
</blockquote>
<a id="more"></a>
<h1 id="Lesson-1"><a href="#Lesson-1" class="headerlink" title="Lesson 1"></a>Lesson 1</h1><h2 id="创建用户并分配权限"><a href="#创建用户并分配权限" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建测试schema，命名为test"><a href="#创建测试schema，命名为test" class="headerlink" title="创建测试schema，命名为test"></a>创建测试schema，命名为test</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create user test identified by test;</span><br></pre></td></tr></table></figure>
<h3 id="分配连接资源"><a href="#分配连接资源" class="headerlink" title="分配连接资源"></a>分配连接资源</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant connect,resource to test;</span><br><span class="line">grant execute on dbms_lock to test;</span><br><span class="line">grant execute on UTL_FILE to test;</span><br></pre></td></tr></table></figure>
<h3 id="为test用户创建external-data目录以及分配权限"><a href="#为test用户创建external-data目录以及分配权限" class="headerlink" title="为test用户创建external_data目录以及分配权限"></a>为test用户创建external_data目录以及分配权限</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create directory external_data as &apos;/home/oracle/data&apos;;</span><br><span class="line">grant read,write on directory external_data to test;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>要注意oracle用户必须拥有对这里的external_data路径读写的权限。</p>
</blockquote>
<h3 id="分配表空间权限"><a href="#分配表空间权限" class="headerlink" title="分配表空间权限"></a>分配表空间权限</h3><p>我们知道oracle中没有库的概念，取而代之的是表空间（Tablespace），在oracle初次被安装时，数据库中只有系统本身内置的表空间：</p>
<ul>
<li><strong>SYSTEM</strong> - 存储数据字典</li>
<li><strong>SYSAUX</strong> - 存储辅助应用程序的数据</li>
<li><strong>TEMP</strong> - 存储数据库临时对象</li>
<li><strong>USERS</strong> - 存储各个用户创建的对象</li>
<li><strong>UNDOTBS</strong> - 存储不一致数据，用于事物回滚、数据库恢复、读一致性、闪回查询</li>
<li>……</li>
</ul>
<p>而当第一次通过管理员创建一个用户且未为其创建并指定表空间时，数据库系统会为其指定默认的表空间为SYSTEM，而他并没有使用SYSTEM表空间的权限，因此该用户无法完成建表等操作，可通过执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- DBA下执行：</span><br><span class="line">-- 查看数据库中的所有表空间</span><br><span class="line">select * from v$tablespace;</span><br><span class="line">-- 查看当前用户所在的表空间(注意oracle系统表中存储的用户名字段都是大写，要注意这与“oracle中不区分大小写”这一概念区分开来)</span><br><span class="line">select username,default_tablespace from dba_users where username=&apos;TEST&apos;;</span><br><span class="line">-- 为用户赋予当前表空间下的权限</span><br><span class="line">alter user test quota unlimited on users;</span><br><span class="line">--  或者制定用户可用大小：</span><br><span class="line">alter user test quota 50M on users;</span><br></pre></td></tr></table></figure>
<h2 id="连接用户，建表，跑存储过程和函数"><a href="#连接用户，建表，跑存储过程和函数" class="headerlink" title="连接用户，建表，跑存储过程和函数"></a>连接用户，建表，跑存储过程和函数</h2><h3 id="连接test用户"><a href="#连接test用户" class="headerlink" title="连接test用户"></a>连接test用户</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-- 在系统命令下连接</span><br><span class="line">cd $ORACLE_HOME/bin</span><br><span class="line">./sqlplus test/test</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 在进入sqlplus后的连接</span><br><span class="line">conn test/test</span><br></pre></td></tr></table></figure>
<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create table t_mobiles(f_id number(6),f_mobile_head varchar2(50),f_province varchar2(50),f_city varchar2(50),f_platform varchar2(50),f_tel_head varchar2(50),f_zipcode varchar2(50),primary key(f_id));</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_ID IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_MOBILE_HEAD IS &apos;手机号段&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_PROVINCE IS &apos;省份地区&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_CITY IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_PLATFORM IS &apos;运营商&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_TEL_HEAD IS &apos;固话区号&apos;;</span><br><span class="line">COMMENT ON COLUMN T_MOBILES.F_ZIPCODE IS &apos;邮政编码&apos;;</span><br><span class="line">COMMENT ON TABLE T_MOBILES  IS &apos;号段表&apos;;</span><br><span class="line"></span><br><span class="line">create table t_records(f_id number(6),f_no varchar2(50),f_begin_time date,f_end_time date,f_duration number(10,0),f_province VARCHAR2(50), f_platform varchar2(50), f_mobile NUMBER(1) DEFAULT -1);</span><br><span class="line">--*注：因f_id导入时缺少数据，所有先不设置为PK.</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_ID IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_NO IS &apos;通话号码&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_BEGIN_TIME IS &apos;开始时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_END_TIME IS &apos;结束时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_DURATION IS &apos;通话时长&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_PROVINCE IS &apos;省份地区&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_PLATFORM IS &apos;运营商&apos;;</span><br><span class="line">COMMENT ON COLUMN T_RECORDS.F_MOBILE IS &apos;手机号码标志&apos;;</span><br><span class="line">COMMENT ON TABLE T_RECORDS  IS &apos;通话清单表&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="创建ctl文件导入csv数据"><a href="#创建ctl文件导入csv数据" class="headerlink" title="创建ctl文件导入csv数据"></a>创建ctl文件导入csv数据</h3><p>进入<code>external_data</code>路径下并创建以下文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> cd /home/oracle/data</span><br><span class="line"><span class="meta">$</span> vi control_mobiles.ctl</span><br><span class="line"><span class="meta">$</span> vi control_records.ctl</span><br></pre></td></tr></table></figure>
<p><code>control_mobiles.ctl:</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOAD DATA</span><br><span class="line">CHARACTERSET UTF8</span><br><span class="line">INFILE &apos;/home/oracle/data/mobiles.csv&apos;</span><br><span class="line">TRUNCATE INTO TABLE t_mobiles</span><br><span class="line">FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos;</span><br><span class="line">TRAILING NULLCOLS</span><br><span class="line">(</span><br><span class="line">	F_ID,</span><br><span class="line">	F_MOBILE_HEAD,</span><br><span class="line">	F_PROVINCE,</span><br><span class="line">	F_CITY,</span><br><span class="line">	F_PLATFORM,</span><br><span class="line">	F_TEL_HEAD,</span><br><span class="line">	F_ZIPCODE</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>control_records.ctl:</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOAD DATA</span><br><span class="line">CHARACTERSET UTF8</span><br><span class="line">INFILE &apos;/home/oracle/data/records.csv&apos;</span><br><span class="line">TRUNCATE INTO TABLE t_records</span><br><span class="line">FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos;</span><br><span class="line">TRAILING NULLCOLS</span><br><span class="line">(</span><br><span class="line">	F_NO,</span><br><span class="line">	F_BEGIN_TIME DATE &quot;YYYY-MM-DD HH24:MI:SS&quot;,</span><br><span class="line">	F_END_TIME DATE &quot;YYYY-MM-DD HH24:MI:SS&quot;,</span><br><span class="line">	F_DURATION INTEGER EXTERNAL</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在该路径下执行导入操作：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> $ORACLE_HOME/bin/sqlldr userid=test/test control=control_mobiles.ctl</span><br><span class="line"><span class="meta">$</span> $ORACLE_HOME/bin/sqlldr userid=test/test control=control_records.ctl</span><br></pre></td></tr></table></figure>
<blockquote>
<p>教程中命令为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span> $ sqlldr userid=test/test@orcl control=control_mobiles.ctl</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>即在导入时指定<code>连接字符串</code>（这里的orcl实际上是连接字符串的别名），其在<code>$ORACLE_HOME/network/admin/tnsname.ora</code>中被声明，但是默认状态下oracle中并没有配置该连接字符串，意味着我们在连接时不需要为其指定值。</p>
<p>既然如此，应用程序该如何在未进行上述配置的情况下连接到该字符串呢？这里就是<code>连接字符串</code>和<code>服务名</code>的区别，oracle有个默认服务名<code>XE</code>，实际上oracle中还有多个备用服务，当XE服务崩掉的时候会自动切换到备用服务。连接字符串如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; jdbc:oracle:thin:@localhost:1521:XE</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>那么没有配置连接字符串别名时，sqlplus如何通过此方法连接呢？如下直接将连接字符串全部写全：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # 命令格式：sqlplus username/password@host:port/service_name</span><br><span class="line"><span class="meta">&gt;</span> $ sqlplus tanrui/tanrui@127.0.0.1:1521/xe</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h2 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 1、创建序列seq_records_pk用于生成通话记录表t_records的主键</span><br><span class="line">create sequence seq_records increment by 1 start with 1 ;</span><br><span class="line"></span><br><span class="line">-- 2、修补通话记录表t_records的主键数据，并把f_id改为主键</span><br><span class="line">update t_records set f_id=seq_records.nextval;</span><br><span class="line">alter table t_records add constraint t_records_pk primary key (f_id);</span><br><span class="line"></span><br><span class="line">-- 3、创建并初始化同步锁表，用于多线程同步控制</span><br><span class="line">CREATE TABLE T_LOCK(F_NAME VARCHAR2(30),F_INDEX NUMBER(20,0),PRIMARY KEY(F_NAME));</span><br><span class="line">COMMENT ON COLUMN T_LOCK.F_NAME IS &apos;锁名&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOCK.F_INDEX IS &apos;锁的当前值&apos;;</span><br><span class="line">COMMENT ON TABLE T_LOCK  IS &apos;同步锁表&apos;;</span><br><span class="line">insert into T_LOCK values(&apos;_RECORD_INDEX&apos;,0);</span><br><span class="line"></span><br><span class="line">-- 4、在电话号段表中创建唯一性索引，提高号段检索速度</span><br><span class="line">create unique index uniq_mobile_head on t_mobiles(f_mobile_head);</span><br><span class="line">update t_mobiles set f_province = &apos;内蒙古&apos; where f_province = &apos;内蒙&apos;;</span><br><span class="line"></span><br><span class="line">-- 5、创建日志表，用于记录程序执行过程中的日志信息。</span><br><span class="line">create table t_log(f_time date, f_head varchar2(20), f_content varchar2(500));</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_TIME IS &apos;日志时间&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_HEAD IS &apos;日志类型标志&apos;;</span><br><span class="line">COMMENT ON COLUMN T_LOG.F_CONTENT IS &apos;日志内容&apos;;</span><br><span class="line">COMMENT ON TABLE T_LOG  IS &apos;日志表&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="创建函数和存储过程"><a href="#创建函数和存储过程" class="headerlink" title="创建函数和存储过程"></a>创建函数和存储过程</h2><h3 id="声明函数和存储过程"><a href="#声明函数和存储过程" class="headerlink" title="声明函数和存储过程"></a>声明函数和存储过程</h3><ul>
<li>函数is_mobile，判断通话号码是否为手机号码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--函数：判断通话号码是否为手机号码</span><br><span class="line">CREATE OR REPLACE FUNCTION is_mobile(phone VARCHAR2)</span><br><span class="line">    RETURN BOOLEAN IS</span><br><span class="line"></span><br><span class="line">    v_phone VARCHAR2(20);</span><br><span class="line">    v_head VARCHAR2(2);</span><br><span class="line">BEGIN</span><br><span class="line">    --检查参数func</span><br><span class="line">    IF phone IS NULL THEN</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--去除前后空格</span><br><span class="line">    v_phone := TRIM(phone);</span><br><span class="line"></span><br><span class="line">	--去除号码前面的0</span><br><span class="line">    IF substr(v_phone,0,1) = &apos;0&apos; THEN</span><br><span class="line">        v_phone := substr(v_phone, 2);</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--检查手机号码长度</span><br><span class="line">    IF substr(v_phone,0,1) &lt;&gt; &apos;1&apos; OR LENGTH(v_phone) &lt;&gt; 11 THEN</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">	--截取号码前两位</span><br><span class="line">    v_head := substr(v_phone,1,2);</span><br><span class="line"></span><br><span class="line">    IF v_head = &apos;13&apos; OR v_head = &apos;14&apos; OR v_head =&apos;15&apos; OR v_head =&apos;17&apos; OR v_head = &apos;18&apos; THEN</span><br><span class="line">        RETURN TRUE;</span><br><span class="line">    ELSE</span><br><span class="line">        RETURN FALSE;</span><br><span class="line">    END IF;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程init，清空t_log，同时t_lock置零</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--存储过程：初始化测试数据</span><br><span class="line">CREATE OR REPLACE PROCEDURE init IS</span><br><span class="line">    CURSOR job_cursor IS SELECT JOB FROM user_jobs;</span><br><span class="line">BEGIN</span><br><span class="line">	--重置处理位置为0</span><br><span class="line">    EXECUTE IMMEDIATE &apos;update t_lock set f_index=0&apos;;</span><br><span class="line"></span><br><span class="line">	--清除日志表中的记录</span><br><span class="line">    EXECUTE IMMEDIATE &apos;truncate table t_log&apos;;</span><br><span class="line"></span><br><span class="line">	--重置话单表中的记录</span><br><span class="line">    EXECUTE IMMEDIATE &apos;update t_records set f_province = NULL,f_platform=NULL, f_mobile=-1&apos;;</span><br><span class="line">    COMMIT;</span><br><span class="line"></span><br><span class="line">    FOR tmp_job IN job_cursor LOOP</span><br><span class="line">        dbms_job.broken(tmp_job.JOB,TRUE,sysdate);</span><br><span class="line">        dbms_job.REMOVE(tmp_job.JOB);</span><br><span class="line">    END LOOP;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程print，打印日志，存到T_LOG表中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--存储过程：打印日志</span><br><span class="line">CREATE OR REPLACE PROCEDURE print(prefix VARCHAR2, content VARCHAR2) IS</span><br><span class="line">BEGIN</span><br><span class="line">	--dbms_output.put_line(to_char(&apos;yyyy-mm-dd hh24:mi:ss&apos;)||&apos;,&apos;||prefix||&apos;,&apos;||content);</span><br><span class="line">	INSERT INTO t_log VALUES(sysdate,prefix, content);</span><br><span class="line">	COMMIT;</span><br><span class="line">EXCEPTION</span><br><span class="line">	WHEN OTHERS THEN</span><br><span class="line">		dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">		dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程show，显示当前处理情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--存储过程：显示当前处理情况</span><br><span class="line">CREATE OR REPLACE PROCEDURE show IS</span><br><span class="line">	--待处理记录总数</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line"></span><br><span class="line">	--当前日志表记录总数</span><br><span class="line">    v_log_count NUMBER;</span><br><span class="line"></span><br><span class="line">	--当前数据处理位置</span><br><span class="line">    v_current_index NUMBER;</span><br><span class="line"></span><br><span class="line">	--用户Job表游标</span><br><span class="line">    CURSOR job_cursor IS SELECT * FROM user_jobs;</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">    SELECT COUNT(1) INTO v_log_count FROM t_log;</span><br><span class="line">    SELECT f_index INTO v_current_index FROM t_lock;</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line"></span><br><span class="line">	dbms_output.put_line(&apos;log count: &apos;||v_log_count);</span><br><span class="line">    dbms_output.put_line(&apos;record count: &apos;||v_record_count);</span><br><span class="line">    dbms_output.put_line(&apos;current index: &apos;||v_current_index);</span><br><span class="line"></span><br><span class="line">	--清除用户job记录</span><br><span class="line">    FOR tmp_job IN job_cursor LOOP</span><br><span class="line">        dbms_output.put_line(&apos;job:&apos;||tmp_job.JOB||&apos;,broken:&apos;||tmp_job.broken||&apos;,total_time:&apos;||tmp_job.total_time||&apos;,failures:&apos;||tmp_job.failures||&apos;,interval:&apos;||tmp_job.INTERVAL||&apos;,last_sec:&apos;||tmp_job.last_sec||&apos;,next_sec:&apos;||tmp_job.next_sec);</span><br><span class="line"></span><br><span class="line">    END LOOP;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程process_data，提交一个job处理数据</li>
</ul>
<blockquote>
<p><strong>共享锁和排它锁:</strong></p>
<ul>
<li><p>当某事务对数据添加共享锁时，此时该事务<code>只能读不能写</code>，其他事务只能对该数据添加共享锁，而不能添加排它锁</p>
</li>
<li><p>当某事务对数据添加排它锁时，此时该事务<code>既能读又能写</code>，其他事务不能对该数据添加任何锁</p>
</li>
</ul>
<p><strong>autocommit需要关掉:</strong></p>
<p>假设现在有三个job对T_LOCK表进行并发读写，如下：</p>
<p><img src="/images/image-20181124202306595.png" alt="image-20181124202306595"></p>
<p>步骤如下：</p>
<p><img src="/images/锁.png" alt="锁"></p>
<p>阻塞情况：</p>
<p><img src="/images/锁2.png" alt="锁2"></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--存储过程：处理数据</span><br><span class="line">CREATE OR REPLACE PROCEDURE process_data(process_no IN NUMBER, batch_size IN NUMBER) IS</span><br><span class="line">    --定义常量</span><br><span class="line">    c_record_index CONSTANT VARCHAR2(20)   :=&apos;_RECORD_INDEX&apos;;</span><br><span class="line">    c_process_prefix CONSTANT VARCHAR2(20) := &apos;[  PROCESS ]&apos;;</span><br><span class="line">    c_select_record_sql VARCHAR2(100)  := &apos;select * from t_records where f_id &gt;= :x and f_id &lt;= :y&apos;;</span><br><span class="line">    c_select_mobile_sql VARCHAR2(100)  := &apos;select * from t_mobiles where f_mobile_head = :x&apos;;</span><br><span class="line">    c_update_mobile_sql VARCHAR2(100)  := &apos;update t_records set f_province = :x, f_platform = :y, f_mobile = 1 where f_id = :z&apos;;</span><br><span class="line">    c_update_record_sql VARCHAR2(100)  := &apos;update t_records set f_mobile = 0 where f_id = :n&apos;;</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line">    v_current_index NUMBER;</span><br><span class="line">    v_begin_index NUMBER;</span><br><span class="line">    v_end_index NUMBER;</span><br><span class="line">    v_id NUMBER;</span><br><span class="line">    v_phone VARCHAR2(20);</span><br><span class="line">    v_province VARCHAR2(20);</span><br><span class="line">    v_platform VARCHAR2(20);</span><br><span class="line">    --定义动态游标</span><br><span class="line">    TYPE ty_record_cursor IS REF CURSOR;</span><br><span class="line">    record_cursor ty_record_cursor;</span><br><span class="line">    mobile_cursor ty_record_cursor;</span><br><span class="line">    v_record_row t_records%rowtype;</span><br><span class="line">    v_mobile_row t_mobiles%rowtype;</span><br><span class="line">BEGIN</span><br><span class="line">    PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], running...&apos;);</span><br><span class="line">    --获取待处理的记录总数</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line">    PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], records count: &apos;||v_record_count);</span><br><span class="line">    LOOP</span><br><span class="line">        --获取记录锁</span><br><span class="line">        SELECT f_index INTO v_current_index FROM t_lock WHERE f_name = c_record_index FOR UPDATE;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], current index: &apos;||v_current_index);</span><br><span class="line">        IF v_current_index = v_record_count THEN</span><br><span class="line">            PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], finished.&apos;);</span><br><span class="line">            EXIT;</span><br><span class="line">        END IF;</span><br><span class="line">        --记录本次处理的开始和结束记录位置</span><br><span class="line">        v_end_index := v_current_index + batch_size;</span><br><span class="line">        IF v_end_index &gt; v_record_count THEN</span><br><span class="line">            v_end_index := v_record_count;</span><br><span class="line">        END IF;</span><br><span class="line">        --提交事务，释放锁</span><br><span class="line">        UPDATE t_lock SET f_index = v_end_index WHERE f_name =c_record_index;</span><br><span class="line">        COMMIT;</span><br><span class="line">        --计算开始位置</span><br><span class="line">        v_begin_index := v_current_index +1;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], begin index:&apos;||v_begin_index||&apos;, end index:&apos;||v_end_index);</span><br><span class="line">        --test：dbms_lock.sleep(5);</span><br><span class="line">        --查询一批记录进行逐个处理</span><br><span class="line">        OPEN record_cursor FOR c_select_record_sql USING v_begin_index, v_end_index;</span><br><span class="line">        LOOP</span><br><span class="line">            FETCH record_cursor INTO v_record_row;</span><br><span class="line">            EXIT WHEN record_cursor%notfound;</span><br><span class="line">            v_id    := v_record_row.f_id;</span><br><span class="line">            v_phone := v_record_row.f_no;</span><br><span class="line">            IF is_mobile(v_phone) THEN</span><br><span class="line">                v_phone := TRIM(v_phone);</span><br><span class="line">                IF substr(v_phone,0,1) = &apos;0&apos; THEN</span><br><span class="line">                    v_phone := substr(v_phone, 2);</span><br><span class="line">                END IF;</span><br><span class="line">                --PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], id:&apos;||v_id||&apos;, phone:&apos;||v_phone);</span><br><span class="line">                --更新话单记录中的省份、运营商以及手机类型标志</span><br><span class="line">                OPEN mobile_cursor FOR c_select_mobile_sql USING substr(v_phone,1,7);</span><br><span class="line">                    FETCH mobile_cursor INTO v_mobile_row;</span><br><span class="line">                    v_province := v_mobile_row.f_province;</span><br><span class="line">                    v_platform := v_mobile_row.f_platform;</span><br><span class="line">                    --FETCH mobile_cursor INTO v_province, v_platform;</span><br><span class="line">                CLOSE mobile_cursor;</span><br><span class="line">				--更新话单记录的运营商、省份地区信息</span><br><span class="line">                EXECUTE IMMEDIATE c_update_mobile_sql USING v_province,v_platform,v_id;</span><br><span class="line">            ELSE</span><br><span class="line">                --更新话单记录为非移动号码类型</span><br><span class="line">                EXECUTE IMMEDIATE c_update_record_sql USING v_id;</span><br><span class="line">            END IF;</span><br><span class="line">			--提交事务</span><br><span class="line">            COMMIT;</span><br><span class="line">        END LOOP;</span><br><span class="line">        CLOSE record_cursor;</span><br><span class="line">        PRINT(c_process_prefix, &apos;process[&apos;||process_no||&apos;], processed index: &apos;||v_end_index);</span><br><span class="line">    END LOOP;</span><br><span class="line">EXCEPTION</span><br><span class="line">    WHEN OTHERS THEN</span><br><span class="line">        dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">        dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程generate_csv_report，生成报表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--存储过程：生成报表</span><br><span class="line">CREATE OR REPLACE PROCEDURE generate_csv_report IS</span><br><span class="line">	c_report_prefix CONSTANT VARCHAR2(20) := &apos;[  REPORT  ]&apos;;</span><br><span class="line">    v_report_1  UTL_FILE.FILE_TYPE;</span><br><span class="line">    v_report_2  UTL_FILE.FILE_TYPE;</span><br><span class="line">    CURSOR report_1_cursor IS SELECT f_platform,f_province,SUM(f_duration) total FROM t_records WHERE f_mobile=1 GROUP BY f_platform,f_province ORDER BY f_platform ASC,SUM(f_duration) DESC;</span><br><span class="line">    cursor report_2_cursor is select f_province,f_platform,sum(f_duration) total from t_records where f_mobile=1 group by f_province,f_platform order by f_province asc,sum(f_duration) desc;</span><br><span class="line">BEGIN</span><br><span class="line">    --生成报表1，根据运营商分类汇总各省份地区的通话量</span><br><span class="line">    v_report_1 := UTL_FILE.FOPEN( LOCATION =&gt; &apos;EXTERNAL_DATA&apos;, filename =&gt; &apos;report1.csv&apos;, open_mode =&gt; &apos;w&apos;, max_linesize =&gt; 32767);</span><br><span class="line">    FOR cur_tmp IN report_1_cursor LOOP</span><br><span class="line">        UTL_FILE.PUT_LINE(v_report_1, cur_tmp.f_platform || &apos;,&apos; || cur_tmp.f_province || &apos;,&apos; || cur_tmp.total);</span><br><span class="line">    END LOOP;</span><br><span class="line">    UTL_FILE.FCLOSE(v_report_1);</span><br><span class="line">    --生成报表2，根据各省份地区汇总各运营商的通话量</span><br><span class="line">    v_report_2 := UTL_FILE.FOPEN( LOCATION =&gt; &apos;EXTERNAL_DATA&apos;, filename =&gt; &apos;report2.csv&apos;, open_mode =&gt; &apos;w&apos;, max_linesize =&gt; 32767);</span><br><span class="line">    FOR cur_tmp IN report_2_cursor LOOP</span><br><span class="line">        UTL_FILE.PUT_LINE(v_report_2, cur_tmp.f_province || &apos;,&apos; || cur_tmp.f_platform || &apos;,&apos; ||  cur_tmp.total);</span><br><span class="line">    END LOOP;</span><br><span class="line">    UTL_FILE.FCLOSE(v_report_2);</span><br><span class="line">    PRINT(c_report_prefix, &apos;generated reports.&apos;);</span><br><span class="line">    EXCEPTION</span><br><span class="line">        WHEN OTHERS THEN</span><br><span class="line">            dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">            dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程analysis，调用上述函数，完成任务逻辑，支持指定任务个数和一批数量</li>
</ul>
<blockquote>
<p><strong><a href="https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_job.htm#BABHCBFD" target="_blank" rel="noopener">dbms_job</a>:</strong></p>
<p>用于管理job的package</p>
<p><strong>oracle限定的job_queue_processes:</strong></p>
<p>oracle中有一个对任务可启动进程的数量进行限制的参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; SQL&gt; show parameter job_queue_processes;</span><br><span class="line">&gt; NAME				     TYPE	 VALUE</span><br><span class="line">&gt; ----------------------------------------------------------</span><br><span class="line">&gt; job_queue_processeses		 integer	 10</span><br><span class="line">&gt;</span><br><span class="line">&gt; SQL&gt; alter system set job_queue_processes=0...1000;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>使用ctrl+c是无法停止job的:</strong></p>
<p>可使用<code>top</code>命令查看当前进程详情，如果需要结束特定job可kill对应job的进程号</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE OR REPLACE PROCEDURE analysis (job_count IN NUMBER, batch_size IN NUMBER)IS</span><br><span class="line">    --定义常量</span><br><span class="line">    c_record_index CONSTANT VARCHAR2(20)	:=&apos;_RECORD_INDEX&apos;;</span><br><span class="line">	  c_analysis_prefix CONSTANT VARCHAR2(20)	:= &apos;[ ANALYSIS ]&apos;;</span><br><span class="line">    --当前处理位置</span><br><span class="line">    v_record_index NUMBER;</span><br><span class="line">    --待处理的记录总数</span><br><span class="line">    v_record_count NUMBER;</span><br><span class="line">    --保存临时创建的job no</span><br><span class="line">    v_tmp_jobno NUMBER;</span><br><span class="line">    --开始结束时间</span><br><span class="line">    v_begin_time NUMBER;</span><br><span class="line">    v_process_end_time NUMBER;</span><br><span class="line">    v_analysis_end_time NUMBER;</span><br><span class="line">    --异常变量</span><br><span class="line">    e_invalid_input EXCEPTION;</span><br><span class="line">BEGIN</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; start analysis...&apos;);</span><br><span class="line">    --输入参数检查</span><br><span class="line">    IF job_count &lt; 1 OR batch_size&lt;1 THEN</span><br><span class="line">        RAISE e_invalid_input;</span><br><span class="line">    END IF;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; checked input parameters.&apos;);</span><br><span class="line">    --记录开始时间</span><br><span class="line">    v_begin_time := dbms_utility.get_time;</span><br><span class="line">    --获取待处理的记录总数</span><br><span class="line">    SELECT COUNT(1) INTO v_record_count FROM t_records;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; records count: &apos;||v_record_count);</span><br><span class="line">    --开始计算重置为0</span><br><span class="line">    UPDATE t_lock SET f_index=0 WHERE f_name=c_record_index;</span><br><span class="line">    COMMIT;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; reset index to zero.&apos;);</span><br><span class="line">    --提交多个job</span><br><span class="line">    FOR I IN 1.. job_count LOOP</span><br><span class="line">        dbms_job.submit(v_tmp_jobno,&apos;begin process_data(&apos;||I||&apos;,&apos;||batch_size||&apos;); end;&apos;);</span><br><span class="line">        PRINT(c_analysis_prefix, &apos; submitted new job, no: &apos;||v_tmp_jobno);</span><br><span class="line">    END LOOP;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos; created &apos;||job_count||&apos; jobs.&apos;);</span><br><span class="line">    --定时检查处理进度</span><br><span class="line">    LOOP</span><br><span class="line">        SELECT f_index INTO v_record_index FROM t_lock WHERE f_name = c_record_index;</span><br><span class="line">        PRINT(c_analysis_prefix, &apos; current index: &apos;||v_record_index);</span><br><span class="line">        IF v_record_index = v_record_count THEN</span><br><span class="line">            PRINT(c_analysis_prefix, &apos; processed all records, exiting...&apos;);</span><br><span class="line">            EXIT;</span><br><span class="line">        ELSE</span><br><span class="line">            dbms_lock.sleep(5);--暂停等待5秒</span><br><span class="line">        END IF;</span><br><span class="line">    END LOOP;</span><br><span class="line">    v_process_end_time := dbms_utility.get_time;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos;process, elapsed time: &apos;||(v_process_end_time-v_begin_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    dbms_output.put_line(&apos;process, elapsed time: &apos;||(v_process_end_time-v_begin_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    --分类汇总产生报表</span><br><span class="line">    generate_csv_report;</span><br><span class="line">    --结束时间</span><br><span class="line">    v_analysis_end_time := dbms_utility.get_time;</span><br><span class="line">    PRINT(c_analysis_prefix, &apos;report, elapsed time: &apos;||(v_analysis_end_time-v_process_end_time)/100||&apos; seconds.&apos;);</span><br><span class="line">    dbms_output.put_line(&apos;report, elapsed time: &apos;||(v_analysis_end_time-v_process_end_time)/100||&apos; seconds.&apos;);</span><br><span class="line">--异常捕获部分</span><br><span class="line">EXCEPTION</span><br><span class="line">    WHEN e_invalid_input THEN</span><br><span class="line">        dbms_output.put_line(&apos;Invalid input values, job_count:&apos;||job_count||&apos;, batch_size:&apos;||batch_size);</span><br><span class="line">    WHEN OTHERS THEN</span><br><span class="line">        dbms_output.put_line(&apos;Error code: &apos;||SQLCODE);</span><br><span class="line">        dbms_output.put_line(&apos;Error mesg: &apos;||sqlerrm);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<ul>
<li>存储过程mul_analysis，循环调用analysis，指定不同的任务个数和批数量，并将运行时间存入T_RESULT中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 调用多次analysis，指定不同的job数和批数</span><br><span class="line">create or replace procedure mul_analysis is</span><br><span class="line">    -- 最小job数</span><br><span class="line">    v_begin_job_no NUMBER := 3;</span><br><span class="line">    -- 最大job数</span><br><span class="line">    v_end_job_no NUMBER := 8;</span><br><span class="line">    -- 每次增长的batch数量</span><br><span class="line">    v_range NUMBER := 2000;</span><br><span class="line">    -- 最小batch数量</span><br><span class="line">    v_begin_range NUMBER := 1000;</span><br><span class="line">    -- 最大batch数量</span><br><span class="line">    v_end_range NUMBER := 10000;</span><br><span class="line">    -- 当前range</span><br><span class="line">    range NUMBER;</span><br><span class="line">    begin</span><br><span class="line">        for I in v_begin_job_no..v_end_job_no LOOP</span><br><span class="line">            range := v_begin_range;</span><br><span class="line">            LOOP</span><br><span class="line">                -- 清洗表</span><br><span class="line">                init();</span><br><span class="line">                -- 分析</span><br><span class="line">                analysis(I, range);</span><br><span class="line">                range := range+v_range;</span><br><span class="line">				-- range增长到10000则停止</span><br><span class="line">                if range &gt; v_end_range then</span><br><span class="line">                    exit;</span><br><span class="line">                end if;</span><br><span class="line">            end loop;</span><br><span class="line">        end loop;</span><br><span class="line">    end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="执行函数和存储过程"><a href="#执行函数和存储过程" class="headerlink" title="执行函数和存储过程"></a>执行函数和存储过程</h3><blockquote>
<p>在sqlplus中执行函数和存储过程之前需先打开serveroutput，即：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; SQL&gt; set serveroutput on;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>这是因为存储过程中用到了<code>dbms_output.put_line</code>，上述语句是相当于告诉pl/sql引擎将<code>dbms_output.put_line</code>传递到缓冲区的内容输出到主控制台上。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call init();</span><br><span class="line">call analysis(4,1000);</span><br></pre></td></tr></table></figure>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><p>通过执行<code>mul_analysis()</code>对一系列job和batch组合值进行测试，结果如下：</p>
<p><img src="/images/image-20181124205409162.png" alt="image-20181124205409162"></p>
<h1 id="Lesson-2"><a href="#Lesson-2" class="headerlink" title="Lesson 2"></a>Lesson 2</h1><h2 id="创建用户并分配权限-1"><a href="#创建用户并分配权限-1" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create user audittest identified by audittest;</span><br></pre></td></tr></table></figure>
<h3 id="分配权限"><a href="#分配权限" class="headerlink" title="分配权限"></a>分配权限</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant connect,resource to audittest;</span><br><span class="line">grant execute on dbms_lock to audittest;</span><br><span class="line">alter user audittest quota unlimited on users;</span><br><span class="line">conn audittest/audittest;</span><br></pre></td></tr></table></figure>
<h2 id="创建表及其他对象"><a href="#创建表及其他对象" class="headerlink" title="创建表及其他对象"></a>创建表及其他对象</h2><h3 id="创建表-1"><a href="#创建表-1" class="headerlink" title="创建表"></a>创建表</h3><blockquote>
<p>注意：</p>
<p>这里在创建表时添加了<code>ENABLE</code>限制条件，oracle中对表和列的约束有<code>Enable</code>/<code>Disable</code>(启用/禁用)和<code>Validate</code>/<code>NoValidate</code>(验证/不验证)</p>
<p>举两个例子：</p>
<p><strong>需更改的错误：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; -- 创建表，对name字段添加唯一性约束</span><br><span class="line">&gt; drop table T_TEST;</span><br><span class="line">&gt; create table T_TEST(</span><br><span class="line">&gt;   id int primary key ,</span><br><span class="line">&gt;   name varchar2(10) constraint unique_name unique disable</span><br><span class="line">&gt; );</span><br><span class="line">&gt; -- 由于某些错误，添加的记录违反了唯一性约束，但添加不会报错</span><br><span class="line">&gt; begin</span><br><span class="line">&gt;   insert into T_TEST values (1, &apos;tan&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (2, &apos;rui&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (3, &apos;tan&apos;);</span><br><span class="line">&gt; end;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt; -- 修改掉违反唯一性约束的值</span><br><span class="line">&gt; update T_TEST set name=&apos;chen&apos; where id=3;</span><br><span class="line">&gt; -- 使得唯一性约束生效</span><br><span class="line">&gt; alter table T_TEST modify constraint unique_name enable;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>需保留的错误：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; -- 创建表，无约束</span><br><span class="line">&gt; drop table T_TEST;</span><br><span class="line">&gt; create table T_TEST(</span><br><span class="line">&gt;   id int primary key ,</span><br><span class="line">&gt;   name varchar2(10)</span><br><span class="line">&gt; );</span><br><span class="line">&gt; -- 一些old的记录本身可能存在重复数据</span><br><span class="line">&gt; begin</span><br><span class="line">&gt;   insert into T_TEST values (1, &apos;tan&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (2, &apos;rui&apos;);</span><br><span class="line">&gt;   insert into T_TEST values (3, &apos;tan&apos;);</span><br><span class="line">&gt; end;</span><br><span class="line">&gt; select * from T_TEST;</span><br><span class="line">&gt; -- 对name列创建非唯一性索引</span><br><span class="line">&gt; create index i_name on T_TEST(name);</span><br><span class="line">&gt; -- 新要求需要对name添加唯一性约束unique_name，但保留旧值，注意这里一定要使用非唯一性索引</span><br><span class="line">&gt; alter table T_TEST add constraint unique_name unique(name) using index i_name ENABLE NOVALIDATE ;</span><br><span class="line">&gt; -- 此时无法插入name相同的数据了</span><br><span class="line">&gt; insert into T_TEST values (4, &apos;tan&apos;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--部门表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line">	&quot;F_MANAGER&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_DEPARTMENT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_CODE&quot; IS &apos;部门编号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_MANAGER&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_DEPARTMENT&quot;  IS &apos;部门表&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_USER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_USER_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_CODE&quot; IS &apos;员工编号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_TELEPHONE&quot; IS &apos;固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_USER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_USER&quot;  IS &apos;用户表&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_FULL_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CITY&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_BALANCE&quot; NUMBER(10,2) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARTNER&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_SALESMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DELETED_TAG&quot; NUMBER(1,0) DEFAULT 0 NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_VERSION&quot; NUMBER(6,0) DEFAULT 1 NOT NULL ENABLE,</span><br><span class="line">	 PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CODE&quot; IS &apos;客户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_FULL_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_TELEPHONE&quot; IS &apos;联系固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CITY&quot; IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_BALANCE&quot; IS &apos;余额&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_PARTNER&quot; IS &apos;所属合作伙伴&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_SALESMAN&quot; IS &apos;业务员&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_DELETED_TAG&quot; IS &apos;删除标志，0：可用，1：已删除&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MODIFIED_ID&quot; IS &apos;最后修改人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_MODIFIED_TIME&quot; IS &apos;最后修改时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;.&quot;F_VERSION&quot; IS &apos;版本号&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER&quot;  IS &apos;客户信息表&apos;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CODE&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_FULL_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TELEPHONE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CITY&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_BALANCE&quot; NUMBER(10,2) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARTNER&quot; VARCHAR2(45 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_SALESMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DELETED_TAG&quot; NUMBER(1,0) DEFAULT 0 NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MODIFIED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_VERSION&quot; NUMBER(6,0) DEFAULT 1 NOT NULL ENABLE,</span><br><span class="line">	 CONSTRAINT &quot;T_CUSTOMER_HISTORY_PK&quot; PRIMARY KEY (&quot;F_ID&quot;, &quot;F_VERSION&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">--客户信息历史表</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CODE&quot; IS &apos;客户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_FULL_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_TELEPHONE&quot; IS &apos;联系固话&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CITY&quot; IS &apos;城市&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_BALANCE&quot; IS &apos;余额&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_PARTNER&quot; IS &apos;所属合作伙伴&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_SALESMAN&quot; IS &apos;业务员&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_DELETED_TAG&quot; IS &apos;删除标志，0：可用，1：已删除&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MODIFIED_ID&quot; IS &apos;最后修改人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_MODIFIED_TIME&quot; IS &apos;最后修改时间&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;.&quot;F_VERSION&quot; IS &apos;版本号&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_CUSTOMER_HISTORY&quot;  IS &apos;客户信息历史表&apos;;</span><br><span class="line"></span><br><span class="line">--审计表</span><br><span class="line">CREATE TABLE &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_TABLE_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_ROW_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NEW_VERSION&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_COLUMN_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_OLD_VALUE&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_NEW_VALUE&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_OPERATOR_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_OPERATION_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	 CONSTRAINT &quot;T_AUDIT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_ID&quot; IS &apos;主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_TABLE_NAME&quot; IS &apos;表名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_ROW_ID&quot; IS &apos;业务数据主键&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_NEW_VERSION&quot; IS &apos;新的版本号&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_COLUMN_NAME&quot; IS &apos;字段&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OLD_VALUE&quot; IS &apos;原值&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_NEW_VALUE&quot; IS &apos;新值&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OPERATOR_ID&quot; IS &apos;操作用户&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;.&quot;F_OPERATION_TIME&quot; IS &apos;操作时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot;  IS &apos;审计表&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="创建索引、序列"><a href="#创建索引、序列" class="headerlink" title="创建索引、序列"></a>创建索引、序列</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 创建复合索引</span><br><span class="line">CREATE INDEX &quot;AUDITTEST&quot;.&quot;IDX_TABLE_ROWID&quot; ON &quot;AUDITTEST&quot;.&quot;T_AUDIT&quot; (&quot;F_TABLE_NAME&quot;, &quot;F_ROW_ID&quot;) ;</span><br><span class="line">-- 创建序列</span><br><span class="line">CREATE SEQUENCE  SEQ_AUDIT_PK  INCREMENT BY 1 START WITH 1;</span><br></pre></td></tr></table></figure>
<h3 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--创建触发器</span><br><span class="line">create or replace trigger trg_customer_audit</span><br><span class="line">before update on t_customer</span><br><span class="line">for each row</span><br><span class="line">declare</span><br><span class="line">    c_insert_sql constant varchar2(100) := &apos;insert into t_audit values(:1,:2,:3,:4,:5,:6,:7,:8,systimestamp)&apos;;</span><br><span class="line">    c_table_name constant varchar2(20)  := &apos;T_CUSTOMER&apos;;</span><br><span class="line">    v_column_name varchar2(20);</span><br><span class="line">begin</span><br><span class="line">    --记录当前数据到历史表</span><br><span class="line">    insert into t_customer_history values(:old.f_id,:old.f_code,:old.f_full_name,:old.f_linkman,:old.f_mobile,:old.f_telephone,:old.f_email,:old.f_address,:old.f_city,:old.f_balance,:old.f_partner,:old.f_remark,:old.f_salesman,:old.f_deleted_tag,:old.f_created_id,:old.f_created_time,:old.f_modified_id,:old.f_modified_time,:old.f_version);</span><br><span class="line"></span><br><span class="line">    --递增记录的版本号</span><br><span class="line">    :new.f_version := :old.f_version+1;</span><br><span class="line"></span><br><span class="line">    --判断字段变化</span><br><span class="line">    if updating(&apos;F_LINKMAN&apos;) then</span><br><span class="line">        v_column_name := &apos;联系人&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_linkman,:new.f_linkman,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_MOBILE&apos;) then</span><br><span class="line">        v_column_name := &apos;手机号码&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_mobile,:new.f_mobile,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_TELEPHONE&apos;) then</span><br><span class="line">        v_column_name := &apos;固定电话&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_telephone,:new.f_telephone,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_EMAIL&apos;) then</span><br><span class="line">        v_column_name := &apos;电子邮箱&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_email,:new.f_email,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_ADDRESS&apos;) then</span><br><span class="line">        v_column_name := &apos;联系地址&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_address,:new.f_address,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line"></span><br><span class="line">    if updating(&apos;F_BALANCE&apos;) then</span><br><span class="line">        v_column_name := &apos;余额&apos;;</span><br><span class="line">        execute immediate c_insert_sql using seq_audit_pk.nextval,c_table_name,:new.f_id,:old.f_version,v_column_name,:old.f_balance,:new.f_balance,:new.f_modified_id;</span><br><span class="line">    end if;</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--创建过程</span><br><span class="line">--过程：重设序列值</span><br><span class="line">create or replace PROCEDURE reset_seq( seq_name IN VARCHAR2 )</span><br><span class="line">IS</span><br><span class="line">    v_val NUMBER;</span><br><span class="line">BEGIN</span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY -&apos; || v_val ||&apos; MINVALUE 0&apos;;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY 1 MINVALUE 0&apos;;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h3><h4 id="过程reset-seq"><a href="#过程reset-seq" class="headerlink" title="过程reset_seq"></a>过程reset_seq</h4><blockquote>
<p>将序列为输入参数seq_name的值重置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--过程：重设序列值</span><br><span class="line">create or replace PROCEDURE reset_seq( seq_name IN VARCHAR2 )</span><br><span class="line">IS</span><br><span class="line">    v_val NUMBER;</span><br><span class="line">BEGIN</span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY -&apos; || v_val ||&apos; MINVALUE 0&apos;;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;SELECT &apos; || seq_name || &apos;.NEXTVAL FROM dual&apos; INTO v_val;</span><br><span class="line"></span><br><span class="line">    EXECUTE IMMEDIATE &apos;ALTER SEQUENCE &apos; || seq_name || &apos; INCREMENT BY 1 MINVALUE 0&apos;;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="过程init"><a href="#过程init" class="headerlink" title="过程init"></a>过程init</h4><blockquote>
<p>truncate(截断)所有表，重设序列，并添加初始值</p>
<p>注意：</p>
<p><strong><code>truncate</code>与<code>delete</code>的区别</strong>：delete通常用于删除表中的某些行或者所有行，且delete支持回滚，删除掉的记录的物理空间在commit前并不会被回收。truncate只能删除表的所有行且不支持回滚，删除掉的记录的物理空间也会被立刻回收。</p>
<p>truncate的好处在于当需要删除所有行它比delete要快，尤其在包含大量触发器、索引和其他依赖项的情况下；且它不会改变表结构、表依赖等关系，这一特性又使得它比重建表更有效，删除和重建表会使得表的依赖关系断开，因此需要重新创建依赖、创建约束、赋予权限等等操作。</p>
<p>但是truncate也有不好的地方，比如说当被truncate的表被依赖时，举例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; -- 创建表，f_id字段引用T_TEST的主码id</span><br><span class="line">&gt; drop table T_TEST2;</span><br><span class="line">&gt; create table T_TEST2(</span><br><span class="line">&gt;   id1 int primary key ,</span><br><span class="line">&gt;   f_id int,</span><br><span class="line">&gt;   constraint fk</span><br><span class="line">&gt;   foreign key (f_id)</span><br><span class="line">&gt;     references T_TEST(id) on delete cascade</span><br><span class="line">&gt; );</span><br><span class="line">&gt; select *</span><br><span class="line">&gt; from T_TEST2;</span><br><span class="line">&gt; insert into T_TEST2 values(1, 1);</span><br><span class="line">&gt; -- 可级联删除</span><br><span class="line">&gt; delete from T_TEST;</span><br><span class="line">&gt; -- 将外码置为禁用</span><br><span class="line">&gt; alter table T_TEST2 modify constraint fk disable validate ;</span><br><span class="line">&gt; -- 可截断（当不禁用外码时无法截断）</span><br><span class="line">&gt; truncate table T_TEST;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>可见，可通过禁用约束来完成truncate，但是这些主外键约束应是创建数据库时的我们定义的强制关系，上述方法可能会使得这种强制关系紊乱，因此需做好取舍决策。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">create or replace procedure init is</span><br><span class="line">begin</span><br><span class="line">    --清除数据</span><br><span class="line">    execute immediate &apos;truncate table t_audit&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_customer_history&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_customer&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_user&apos;;</span><br><span class="line">    execute immediate &apos;truncate table t_department&apos;;</span><br><span class="line">    --重调序列</span><br><span class="line">    reset_seq(&apos;seq_audit_pk&apos;);</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    insert into t_department values(1,&apos;销售部&apos;,&apos;D01&apos;,NULL,&apos;李明&apos;,&apos;备注1...&apos;);</span><br><span class="line">    insert into t_department values(2,&apos;销售部-北京分部&apos;,&apos;D0101&apos;,1,&apos;赵军&apos;,&apos;备注2...&apos;);</span><br><span class="line">    insert into t_department values(3,&apos;销售部-上海分部&apos;,&apos;D0102&apos;,1,&apos;张华&apos;,&apos;备注3...&apos;);</span><br><span class="line">    insert into t_department values(4,&apos;销售部-深圳分部&apos;,&apos;D0103&apos;,1,&apos;王兵&apos;,&apos;备注4...&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    insert into t_user values(1,1,&apos;仲芳芳&apos;,&apos;U8201&apos;,&apos;女&apos;,&apos;13771234101&apos;,&apos;02131231011&apos;,&apos;use1@samtech.com&apos;,&apos;备注1...&apos;);</span><br><span class="line">    insert into t_user values(2,1,&apos;李明申&apos;,&apos;U8202&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;02131231012&apos;,&apos;use2@samtech.com&apos;,&apos;备注2...&apos;);</span><br><span class="line">    insert into t_user values(3,2,&apos;张雪&apos;, &apos;U8203&apos;,&apos;女&apos;,&apos;13771234103&apos;,&apos;02131231013&apos;,&apos;use3@samtech.com&apos;,&apos;备注3...&apos;);</span><br><span class="line">    insert into t_user values(4,2,&apos;王刚&apos;, &apos;U8204&apos;,&apos;男&apos;,&apos;13771234104&apos;,&apos;02131231014&apos;,&apos;use4@samtech.com&apos;,&apos;备注4...&apos;);</span><br><span class="line">    insert into t_user values(5,3,&apos;赵昌日&apos;,&apos;U8205&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;02131231015&apos;,&apos;use5@samtech.com&apos;,&apos;备注5...&apos;);</span><br><span class="line">    insert into t_user values(6,3,&apos;孙晓华&apos;,&apos;U8206&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;02131231016&apos;,&apos;use6@samtech.com&apos;,&apos;备注6...&apos;);</span><br><span class="line">    insert into t_user values(7,4,&apos;陈亚男&apos;,&apos;U8207&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;02131231017&apos;,&apos;use7@samtech.com&apos;,&apos;备注7...&apos;);</span><br><span class="line">    insert into t_user values(8,4,&apos;刘兵超&apos;,&apos;U8208&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;02131231018&apos;,&apos;use8@samtech.com&apos;,&apos;备注8...&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    insert into t_customer</span><br><span class="line">    values(1,&apos;C1808001&apos;,&apos;上海市永辉电子股份有限公司&apos;,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;02135681589&apos;,&apos;ming@google.com&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;上海市&apos;,12082,&apos;上海中远&apos;,&apos;备注...&apos;,&apos;张娜&apos;,0,1,sysdate,1,sysdate,1);</span><br><span class="line">    commit;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="修改客户信息过程"><a href="#修改客户信息过程" class="headerlink" title="修改客户信息过程"></a>修改客户信息过程</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--过程：修改客户地址</span><br><span class="line">create or replace procedure modify_address</span><br><span class="line">(p_row_id in number,p_address in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_address=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_address,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated address successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户余额</span><br><span class="line">create or replace procedure modify_balance</span><br><span class="line">(p_row_id in number,p_balance in number, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_balance=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_balance,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated balance successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户电子邮箱</span><br><span class="line">create or replace procedure modify_email</span><br><span class="line">(p_row_id in number,p_email in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_email=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_email,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated email successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户联系人</span><br><span class="line">create or replace procedure modify_linkman</span><br><span class="line">(p_row_id in number,p_linkman_name in varchar2, p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_linkman=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_linkman_name,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated linkman name successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改客户联系人信息</span><br><span class="line">create or replace procedure modify_linkman_info</span><br><span class="line">(p_row_id in number,p_linkman_name in varchar2,p_mobile in varchar2,</span><br><span class="line"> p_telephone in varchar2,p_email in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_linkman=:1, f_mobile=:2,</span><br><span class="line">    f_telephone=:3, f_email=:4, f_modified_id=:5, f_modified_time=sysdate where f_id=:6&apos;</span><br><span class="line">    using p_linkman_name,p_mobile,p_telephone,p_email,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated linkman info successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改联系手机</span><br><span class="line">create or replace procedure modify_mobile</span><br><span class="line">(p_row_id in number,p_mobile in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_mobile=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_mobile,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated mobile successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">--过程：修改联系固话</span><br><span class="line">create or replace procedure modify_telephone</span><br><span class="line">(p_row_id in number,p_telephone in varchar2,p_operator in number)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --校验参数省略</span><br><span class="line">    --...</span><br><span class="line">    execute immediate &apos;update t_customer set f_telephone=:1,f_modified_id=:2, f_modified_time=sysdate where f_id=:3&apos;</span><br><span class="line">    using p_telephone,p_operator,p_row_id;</span><br><span class="line">    commit;</span><br><span class="line">    dbms_output.put_line(&apos;Updated mobile successfully.&apos;);</span><br><span class="line"></span><br><span class="line">    --异常捕获省略</span><br><span class="line">    --...</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 初始化</span><br><span class="line">call init();</span><br><span class="line"></span><br><span class="line">-- 更改客户信息</span><br><span class="line">begin</span><br><span class="line">	modify_linkman(1,&apos;李明顺&apos;,1);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_mobile(1,&apos;13771083211&apos;,2);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_balance(1,20020,3);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_address(1,&apos;中国上海市嘉定区xxx路&apos;,4);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_email(1,&apos;test1@163.com&apos;,5);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_telephone(1,&apos;02183652145&apos;,6);</span><br><span class="line">	dbms_lock.sleep(1);</span><br><span class="line">	modify_linkman_info(1,&apos;张雨轩&apos;,&apos;15332892301&apos;,&apos;02188881111&apos;,&apos;zhangyx@gmail.com&apos;,7);</span><br><span class="line">end;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">-- 审计</span><br><span class="line">select * from T_AUDIT;</span><br><span class="line"></span><br><span class="line">-- 回滚客户信息</span><br><span class="line">-- 方法1：</span><br><span class="line">update t_customer a</span><br><span class="line">set(</span><br><span class="line">a.f_full_name,a.f_linkman,a.f_mobile,a.f_telephone,a.f_email,a.f_address,</span><br><span class="line">a.f_city,a.f_balance,a.f_partner,a.f_remark,a.f_salesman,a.f_deleted_tag,</span><br><span class="line">a.f_modified_id,a.f_modified_time</span><br><span class="line">)</span><br><span class="line">=</span><br><span class="line">(</span><br><span class="line">select b.f_full_name,b.f_linkman,b.f_mobile,b.f_telephone,b.f_email,</span><br><span class="line">b.f_address,b.f_city,b.f_balance,b.f_partner,b.f_remark,b.f_salesman,</span><br><span class="line">b.f_deleted_tag,5,sysdate</span><br><span class="line">from t_customer_history b where b.f_id=a.f_id and b.f_version=3</span><br><span class="line">)</span><br><span class="line">where a.f_id=1;</span><br><span class="line">-- 方法2：</span><br><span class="line">merge into t_customer a using t_customer_history b on (a.f_id=1 and a.f_id=b.f_id and b.f_version=3)</span><br><span class="line">when matched then</span><br><span class="line">update set a.f_full_name=b.f_full_name,a.f_linkman=b.f_linkman,a.f_mobile=b.f_mobile,a.f_telephone=b.f_telephone,</span><br><span class="line">a.f_email=b.f_email,a.f_address=b.f_address,a.f_city=b.f_city,a.f_balance=b.f_balance,a.f_partner=b.f_partner,</span><br><span class="line">a.f_remark=b.f_remark,a.f_salesman=b.f_salesman,a.f_deleted_tag=b.f_deleted_tag,a.f_modified_id=5,a.f_modified_time=sysdate;</span><br><span class="line"></span><br><span class="line">-- 查看验证数据</span><br><span class="line">select * from t_customer where f_id=1</span><br><span class="line">union</span><br><span class="line">select * from t_customer_history where f_id=1 and f_version=3;</span><br></pre></td></tr></table></figure>
<h1 id="Lesson-3"><a href="#Lesson-3" class="headerlink" title="Lesson 3"></a>Lesson 3</h1><h2 id="创建用户并分配权限-2"><a href="#创建用户并分配权限-2" class="headerlink" title="创建用户并分配权限"></a>创建用户并分配权限</h2><h3 id="创建用户-1"><a href="#创建用户-1" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create user permission identified by permission;</span><br></pre></td></tr></table></figure>
<h3 id="分配权限-1"><a href="#分配权限-1" class="headerlink" title="分配权限"></a>分配权限</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant connect,resource to permission;</span><br><span class="line">alter user permisson quota unlimited on users;</span><br><span class="line">conn permission/permission;</span><br></pre></td></tr></table></figure>
<h2 id="创建表及其他对象-1"><a href="#创建表及其他对象-1" class="headerlink" title="创建表及其他对象"></a>创建表及其他对象</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><blockquote>
<p>方案一在T_CUSTOMER表中存放创建人员ID，以查询该客户的直接负责人，在T_USER表中存放直属领导的ID，用于查询某领导所有下属的客户。</p>
</blockquote>
<h4 id="创建表-2"><a href="#创建表-2" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">--方案一</span><br><span class="line">--部门表</span><br><span class="line">CREATE TABLE T_DEPARTMENT</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line">	&quot;F_MANAGER_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_DEPARTMENT_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_MANAGER_ID&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_DEPARTMENT&quot;  IS &apos;部门表&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;T_USER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	 CONSTRAINT &quot;T_USER_PK&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_USER&quot;  IS &apos;用户表&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;T_CUSTOMER&quot;</span><br><span class="line">(	&quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line">	&quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">	&quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line">	&quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">	 PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_CUSTOMER&quot;  IS &apos;客户信息表&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="创建过程-1"><a href="#创建过程-1" class="headerlink" title="创建过程"></a>创建过程</h4><h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">CREATE OR REPLACE PROCEDURE INIT IS</span><br><span class="line">BEGIN</span><br><span class="line">    --清除数据</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_CUSTOMER&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_DEPARTMENT&apos;;</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(1,&apos;公司&apos;,NULL,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(2,&apos;行政部&apos;,1,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(3,&apos;销售部&apos;,1,2,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(4,&apos;电销组&apos;,3,3,&apos;销售部电销组&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT VALUES(5,&apos;推销组&apos;,3,6,&apos;销售部推销组&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    INSERT INTO T_USER VALUES(1,1,&apos;管理员&apos;,&apos;男&apos;,&apos;13771234101&apos;,&apos;USE1@SAMTECH.COM&apos;,&apos;系统管理员&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(2,3,&apos;李明申&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;USE2@SAMTECH.COM&apos;,&apos;销售部经理&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(3,4,&apos;张雪&apos;, &apos;女&apos;,&apos;13771234103&apos;,&apos;USE3@SAMTECH.COM&apos;,&apos;销售部电销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(4,4,&apos;王刚&apos;, &apos;男&apos;,&apos;13771234104&apos;,&apos;USE4@SAMTECH.COM&apos;,&apos;销售部电销组业务员1&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(5,4,&apos;赵昌日&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;USE5@SAMTECH.COM&apos;,&apos;销售部电销组业务员2&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(6,5,&apos;孙晓华&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;USE6@SAMTECH.COM&apos;,&apos;销售部推销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(7,5,&apos;陈亚男&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;USE7@SAMTECH.COM&apos;,&apos;销售部推销组业务员3&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(8,5,&apos;刘兵超&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;USE8@SAMTECH.COM&apos;,&apos;销售部推销组业务员4&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(9,3,&apos;陈彬&apos;,&apos;女&apos;,&apos;13771234109&apos;,&apos;USE9@SAMTECH.COM&apos;,&apos;销售部业务员X1&apos;);</span><br><span class="line">    INSERT INTO T_USER VALUES(10,3,&apos;王军&apos;,&apos;男&apos;,&apos;13771234110&apos;,&apos;USE10@SAMTECH.COM&apos;,&apos;销售部业务员X2&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(1,&apos;上海市永辉电子股份有限公司&apos;     ,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;MING1@GOOGLE.COM&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;电销组主管创建&apos;,3,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(2,&apos;上海博运汽车销售有限公司&apos;      ,&apos;朱荣荣&apos; ,&apos;13231289212&apos;,&apos;MING2@GOOGLE.COM&apos;,&apos;上海市徐汇区钦江路256号&apos;,&apos;电销组业务员1创建&apos;,4,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(3,&apos;安徽广宏顶管装备制造有限公司&apos;   ,&apos;邱阳阳&apos; ,&apos;15328921231&apos;,&apos;MING3@GOOGLE.COM&apos;,&apos;安徽省广德县经济开发区东纬路5号&apos;,&apos;电销组业务员2创建&apos;,5,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(4,&apos;上海定丰霖贸易有限公司&apos;        ,&apos;赵兰&apos;  ,&apos;15532212322&apos;,&apos;MING4@GOOGLE.COM&apos;,&apos;上海市浦东新区东延路112号408室&apos;,&apos;推销组主管创建&apos;,6,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(5,&apos;上海东俊科技有限公司&apos;          ,&apos;张军&apos;  ,&apos;15367823660&apos;,&apos;MING5@GOOGLE.COM&apos;,&apos;上海市长宁区王安路135号&apos;,&apos;推销组业务员1创建&apos;,7,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(6,&apos;中科创客（深圳）智能工业设备公司&apos;,&apos;李明&apos;  ,&apos;17723180234&apos;,&apos;MING6@GOOGLE.COM&apos;,&apos;深圳市龙岗区富民工业园致康路301号&apos;,&apos;推销组业务员2创建&apos;,8,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(7,&apos;南宁云讯科技有限公司&apos;          ,&apos;王永成&apos;,&apos;13568932166&apos;,&apos;MING7@GOOGLE.COM&apos;,&apos;广东省深圳市福田区长川路102号&apos;,&apos;销售部业务员X1创建&apos;,9,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER VALUES(8,&apos;沈阳优速家政服务有限公司&apos;       ,&apos;李东升&apos;,&apos;13392312343&apos;,&apos;MING8@GOOGLE.COM&apos;,&apos;辽宁省沈阳市铁西区北二路青年易居东门32号&apos;,&apos;销售部业务员X2创建&apos;,10,SYSDATE);</span><br><span class="line">    COMMIT;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h4 id="执行-1"><a href="#执行-1" class="headerlink" title="执行"></a>执行</h4><h5 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set serveroutput on;</span><br><span class="line">exec init;</span><br></pre></td></tr></table></figure>
<h5 id="查询自己的客户"><a href="#查询自己的客户" class="headerlink" title="查询自己的客户"></a>查询自己的客户</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM t_customer A WHERE A.f_created_id=&amp;id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&amp;id</code>是所查询人员的ID</p>
</blockquote>
<h5 id="查询某领导下属人员的所有客户"><a href="#查询某领导下属人员的所有客户" class="headerlink" title="查询某领导下属人员的所有客户"></a>查询某领导下属人员的所有客户</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from t_user a  where exists(</span><br><span class="line">SELECT 1 FROM t_department b</span><br><span class="line">WHERE a.f_dept_id=b.f_id and b.f_manager_id=&amp;id</span><br><span class="line">CONNECT BY b.F_PARENT_ID = PRIOR b.F_ID</span><br><span class="line">start with b.F_ID = (select c.f_dept_id from t_user c where c.f_id=&amp;id));</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&amp;id</code>是该领导的ID</p>
</blockquote>
<h4 id="当部门结构或员工归属调整时，权限编码如何处理？"><a href="#当部门结构或员工归属调整时，权限编码如何处理？" class="headerlink" title="当部门结构或员工归属调整时，权限编码如何处理？"></a>当部门结构或员工归属调整时，权限编码如何处理？</h4><p>对于方案一，只需要更改员工直属领导ID即可</p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><blockquote>
<p>方案二取消在T_USER中添加直属领导ID，改为在员工、部门、客户表中添加权限码，查看时直接搜索对应权限码即可</p>
</blockquote>
<h4 id="创建表-3"><a href="#创建表-3" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--方案二</span><br><span class="line">--部门表</span><br><span class="line">CREATE TABLE T_DEPARTMENT_2</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">    &quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_PARENT_ID&quot; NUMBER(6,0),</span><br><span class="line"> &quot;F_MANAGER_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">  CONSTRAINT &quot;T_DEPARTMENT_PK2&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_NAME&quot; IS &apos;部门名称&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_CODE&quot; IS &apos;部门编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_PARENT_ID&quot; IS &apos;上级部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_MANAGER_ID&quot; IS &apos;部门经理&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_DEPARTMENT_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_DEPARTMENT_2&quot;  IS &apos;部门表2&apos;;</span><br><span class="line"></span><br><span class="line">--用户表</span><br><span class="line">CREATE TABLE &quot;T_USER_2&quot;</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_DEPT_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line">    &quot;F_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_SEX&quot; VARCHAR2(5 BYTE) DEFAULT NULL,</span><br><span class="line"> &quot;F_MOBILE&quot; VARCHAR2(20 BYTE),</span><br><span class="line"> &quot;F_EMAIL&quot; VARCHAR2(50 BYTE),</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">  CONSTRAINT &quot;T_USER_PK2&quot; PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_DEPT_ID&quot; IS &apos;部门ID&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_NAME&quot; IS &apos;用户名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_CODE&quot; IS &apos;用户编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_SEX&quot; IS &apos;性别&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_MOBILE&quot; IS &apos;手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_EMAIL&quot; IS &apos;邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_USER_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_USER_2&quot;  IS &apos;用户表2&apos;;</span><br><span class="line"></span><br><span class="line">--客户信息表</span><br><span class="line">CREATE TABLE &quot;T_CUSTOMER_2&quot;</span><br><span class="line">(  &quot;F_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_NAME&quot; VARCHAR2(145 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_LINKMAN&quot; VARCHAR2(45 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_MOBILE&quot; VARCHAR2(11 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_EMAIL&quot; VARCHAR2(60 BYTE),</span><br><span class="line"> &quot;F_ADDRESS&quot; VARCHAR2(200 BYTE),</span><br><span class="line"> &quot;F_REMARK&quot; VARCHAR2(200 BYTE),</span><br><span class="line">    &quot;F_ACCESS_CODE&quot; VARCHAR2(50 BYTE) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_CREATED_ID&quot; NUMBER(6,0) NOT NULL ENABLE,</span><br><span class="line"> &quot;F_CREATED_TIME&quot; TIMESTAMP (6) NOT NULL ENABLE,</span><br><span class="line">  PRIMARY KEY (&quot;F_ID&quot;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ID&quot; IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_NAME&quot; IS &apos;客户全名&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_LINKMAN&quot; IS &apos;联系人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_MOBILE&quot; IS &apos;联系手机&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_EMAIL&quot; IS &apos;联系邮箱&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ADDRESS&quot; IS &apos;地址&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_REMARK&quot; IS &apos;备注信息&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_ACCESS_CODE&quot; IS &apos;权限编码&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_CREATED_ID&quot; IS &apos;创建人&apos;;</span><br><span class="line">COMMENT ON COLUMN &quot;T_CUSTOMER_2&quot;.&quot;F_CREATED_TIME&quot; IS &apos;创建时间&apos;;</span><br><span class="line">COMMENT ON TABLE &quot;T_CUSTOMER_2&quot;  IS &apos;客户信息表2&apos;;</span><br><span class="line"></span><br><span class="line">-- 创建人员更改历史表</span><br><span class="line">CREATE TABLE T_USER_HISTORY(</span><br><span class="line">  ID NUMBER(6,0) PRIMARY KEY ,</span><br><span class="line">  F_ID NUMBER(6,0) ,</span><br><span class="line">  O_DEP_ID NUMBER(6,0) ,</span><br><span class="line">  O_ACCESS_CODE VARCHAR2(50 BYTE) ,</span><br><span class="line">  N_DEP_ID  NUMBER(6,0),</span><br><span class="line">  N_ACCESS_CODE VARCHAR2(50 BYTE),</span><br><span class="line">  TIME DATE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.ID IS &apos;PK&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.F_ID IS &apos;修改的人员ID&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.O_DEP_ID IS &apos;旧的部门&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.O_ACCESS_CODE IS &apos;旧的权限&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.N_DEP_ID IS &apos;新的部门&apos;;</span><br><span class="line">COMMENT ON COLUMN T_USER_HISTORY.N_ACCESS_CODE IS &apos;新的权限&apos;;</span><br><span class="line">COMMENT ON TABLE T_USER_HISTORY IS &apos;用户权限更改历史&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="创建过程-2"><a href="#创建过程-2" class="headerlink" title="创建过程"></a>创建过程</h4><h5 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--过程：数据初始化</span><br><span class="line">CREATE OR REPLACE PROCEDURE INIT2 IS</span><br><span class="line">BEGIN</span><br><span class="line">    --清除数据</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_CUSTOMER_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_DEPARTMENT_2&apos;;</span><br><span class="line">    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_USER_HISTORY&apos;;</span><br><span class="line"></span><br><span class="line">    --插入部门</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(1,&apos;公司&apos;,&apos;1&apos;,NULL,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(2,&apos;行政部&apos;,&apos;101&apos;,1,1,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(3,&apos;销售部&apos;,&apos;102&apos;,1,2,&apos;REMARK...&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(4,&apos;电销组&apos;,&apos;10201&apos;,3,3,&apos;销售部电销组&apos;);</span><br><span class="line">    INSERT INTO T_DEPARTMENT_2 VALUES(5,&apos;推销组&apos;,&apos;10202&apos;,3,6,&apos;销售部推销组&apos;);</span><br><span class="line"></span><br><span class="line">    --插入用户</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(1,1,&apos;管理员&apos;,&apos;1&apos;,&apos;男&apos;,&apos;13771234101&apos;,&apos;USE1@SAMTECH.COM&apos;,&apos;系统管理员&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(2,3,&apos;李明申&apos;,&apos;102&apos;,&apos;男&apos;,&apos;13771234102&apos;,&apos;USE2@SAMTECH.COM&apos;,&apos;销售部经理&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(3,4,&apos;张雪&apos;,  &apos;10201&apos;, &apos;女&apos;,&apos;13771234103&apos;,&apos;USE3@SAMTECH.COM&apos;,&apos;销售部电销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(4,4,&apos;王刚&apos;,  &apos;1020101&apos;, &apos;男&apos;,&apos;13771234104&apos;,&apos;USE4@SAMTECH.COM&apos;,&apos;销售部电销组业务员1&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(5,4,&apos;赵昌日&apos;,&apos;1020102&apos;,&apos;男&apos;,&apos;13771234105&apos;,&apos;USE5@SAMTECH.COM&apos;,&apos;销售部电销组业务员2&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(6,5,&apos;孙晓华&apos;,&apos;10202&apos;,&apos;男&apos;,&apos;13771234106&apos;,&apos;USE6@SAMTECH.COM&apos;,&apos;销售部推销组主管&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(7,5,&apos;陈亚男&apos;,&apos;1020201&apos;,&apos;女&apos;,&apos;13771234107&apos;,&apos;USE7@SAMTECH.COM&apos;,&apos;销售部推销组业务员3&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(8,5,&apos;刘兵超&apos;,&apos;1020202&apos;,&apos;男&apos;,&apos;13771234108&apos;,&apos;USE8@SAMTECH.COM&apos;,&apos;销售部推销组业务员4&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(9,3,&apos;陈彬&apos;,  &apos;10203&apos;,&apos;女&apos;,&apos;13771234109&apos;,&apos;USE9@SAMTECH.COM&apos;,&apos;销售部业务员X1&apos;);</span><br><span class="line">    INSERT INTO T_USER_2 VALUES(10,3,&apos;王军&apos;, &apos;10204&apos;,&apos;男&apos;,&apos;13771234110&apos;,&apos;USE10@SAMTECH.COM&apos;,&apos;销售部业务员X2&apos;);</span><br><span class="line"></span><br><span class="line">    --插入客户</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(1,&apos;上海市永辉电子股份有限公司&apos;     ,&apos;张明升&apos;,&apos;15352678121&apos;,&apos;MING1@GOOGLE.COM&apos;,&apos;上海市静安区城区安泰路1108号&apos;,&apos;电销组主管创建&apos;,&apos;10201&apos;,3,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(2,&apos;上海博运汽车销售有限公司&apos;      ,&apos;朱荣荣&apos; ,&apos;13231289212&apos;,&apos;MING2@GOOGLE.COM&apos;,&apos;上海市徐汇区钦江路256号&apos;,&apos;电销组业务员1创建&apos;,&apos;1020101&apos;,4,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(3,&apos;安徽广宏顶管装备制造有限公司&apos;   ,&apos;邱阳阳&apos; ,&apos;15328921231&apos;,&apos;MING3@GOOGLE.COM&apos;,&apos;安徽省广德县经济开发区东纬路5号&apos;,&apos;电销组业务员2创建&apos;,&apos;1020102&apos;,5,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(4,&apos;上海定丰霖贸易有限公司&apos;        ,&apos;赵兰&apos;  ,&apos;15532212322&apos;,&apos;MING4@GOOGLE.COM&apos;,&apos;上海市浦东新区东延路112号408室&apos;,&apos;推销组主管创建&apos;,&apos;10202&apos;,6,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(5,&apos;上海东俊科技有限公司&apos;          ,&apos;张军&apos;  ,&apos;15367823660&apos;,&apos;MING5@GOOGLE.COM&apos;,&apos;上海市长宁区王安路135号&apos;,&apos;推销组业务员1创建&apos;,&apos;1020201&apos;,7,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(6,&apos;中科创客（深圳）智能工业设备公司&apos;,&apos;李明&apos;  ,&apos;17723180234&apos;,&apos;MING6@GOOGLE.COM&apos;,&apos;深圳市龙岗区富民工业园致康路301号&apos;,&apos;推销组业务员2创建&apos;,&apos;1020202&apos;,8,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(7,&apos;南宁云讯科技有限公司&apos;          ,&apos;王永成&apos;,&apos;13568932166&apos;,&apos;MING7@GOOGLE.COM&apos;,&apos;广东省深圳市福田区长川路102号&apos;,&apos;销售部业务员X1创建&apos;,&apos;10203&apos;,9,SYSDATE);</span><br><span class="line">    INSERT INTO T_CUSTOMER_2 VALUES(8,&apos;沈阳优速家政服务有限公司&apos;       ,&apos;李东升&apos;,&apos;13392312343&apos;,&apos;MING8@GOOGLE.COM&apos;,&apos;辽宁省沈阳市铁西区北二路青年易居东门32号&apos;,&apos;销售部业务员X2创建&apos;,&apos;10204&apos;,10,SYSDATE);</span><br><span class="line">    COMMIT;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h5 id="将某员工调换到某部门"><a href="#将某员工调换到某部门" class="headerlink" title="将某员工调换到某部门"></a>将某员工调换到某部门</h5><p><img src="/images/image-20181126025537963.png" alt="image-20181126025537963"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 更改用户到特定部门</span><br><span class="line">CREATE OR REPLACE PROCEDURE CHANGE_TO_DEPARTMENT(C_F_ID IN T_USER_2.F_ID%TYPE, N_DEP_ID IN T_DEPARTMENT_2.F_ID%TYPE) IS</span><br><span class="line">  -- 旧部门</span><br><span class="line">  O_DEP_ID T_DEPARTMENT_2.F_ID%TYPE;</span><br><span class="line">  -- 旧权限</span><br><span class="line">  O_ACCESS_CODE T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 部门权限前缀</span><br><span class="line">  DEP_ACCESS_CODE_PREFIX T_DEPARTMENT_2.F_CODE%TYPE;</span><br><span class="line">  -- 部门当前人数</span><br><span class="line">  DEP_USER_COUNT T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 本部门下的部门数</span><br><span class="line">  DEP_DEP_COUNT T_DEPARTMENT_2.F_CODE%TYPE;</span><br><span class="line">  -- 新权限</span><br><span class="line">  N_ACCESS_CODE T_USER_2.F_CODE%TYPE;</span><br><span class="line">  -- 更新该员工权限</span><br><span class="line">  C_UPDATE_USER VARCHAR2(100) := &apos;UPDATE T_USER_2 SET F_CODE = :1, F_DEPT_ID = :2 WHERE F_ID = :3&apos;;</span><br><span class="line">  -- 更新所有该员工的客户的ACCESS权限</span><br><span class="line">  C_UPDATE_CUSTOMER VARCHAR2(100) := &apos;UPDATE T_CUSTOMER_2 SET F_ACCESS_CODE = :1 WHERE F_CREATED_ID = :2&apos;;</span><br><span class="line">  -- 插入一条修改记录</span><br><span class="line">  C_INSERT_HISTORY VARCHAR2(100) := &apos;INSERT INTO T_USER_HISTORY VALUES (:1, :2, :3, :4, :5, :6, :7)&apos;;</span><br><span class="line">  BEGIN</span><br><span class="line">    -- 旧部门</span><br><span class="line">    SELECT F_DEPT_ID INTO O_DEP_ID FROM T_USER_2 WHERE T_USER_2.F_ID=C_F_ID;</span><br><span class="line">    -- 旧权限</span><br><span class="line">    SELECT F_CODE INTO O_ACCESS_CODE FROM T_USER_2 WHERE T_USER_2.F_ID=C_F_ID;</span><br><span class="line">    -- 新部门权限作为前缀</span><br><span class="line">    SELECT F_CODE INTO DEP_ACCESS_CODE_PREFIX FROM T_DEPARTMENT_2 WHERE T_DEPARTMENT_2.F_ID = N_DEP_ID;</span><br><span class="line">    -- 计算该部门人员数量</span><br><span class="line">    SELECT MAX(T_USER_2.F_CODE) INTO DEP_USER_COUNT FROM T_USER_2 WHERE T_USER_2.F_DEPT_ID = N_DEP_ID;</span><br><span class="line">    -- 计算子部门数量</span><br><span class="line">    SELECT MAX(T_DEPARTMENT_2.F_CODE) INTO DEP_DEP_COUNT FROM T_DEPARTMENT_2 WHERE SUBSTR(T_DEPARTMENT_2.F_CODE, 0, LENGTH(DEP_ACCESS_CODE_PREFIX))=DEP_ACCESS_CODE_PREFIX AND LENGTH(T_DEPARTMENT_2.F_CODE)=LENGTH(DEP_ACCESS_CODE_PREFIX)+2;</span><br><span class="line">    -- 若新部门与旧部门相同，无需更改</span><br><span class="line">    IF N_DEP_ID=O_DEP_ID THEN</span><br><span class="line">      RETURN;</span><br><span class="line">    END IF;</span><br><span class="line">    -- 新权限CODE</span><br><span class="line">    IF DEP_DEP_COUNT &gt; DEP_USER_COUNT THEN</span><br><span class="line">      N_ACCESS_CODE := TO_CHAR(TO_NUMBER(DEP_DEP_COUNT) + 1);</span><br><span class="line">    ELSE</span><br><span class="line">      N_ACCESS_CODE := TO_CHAR(TO_NUMBER(DEP_USER_COUNT) + 1);</span><br><span class="line">    end if;</span><br><span class="line">    -- 输出相关变量</span><br><span class="line">    dbms_output.put_line(&apos;DEP_USER_COUNT : &apos; || DEP_USER_COUNT);</span><br><span class="line">    dbms_output.put_line(&apos;DEP_DEP_COUNT : &apos; || DEP_DEP_COUNT);</span><br><span class="line">    -- 输出相关变量</span><br><span class="line">    dbms_output.put_line(&apos;DEP_ACCESS_CODE_PREFIX : &apos; || DEP_ACCESS_CODE_PREFIX);</span><br><span class="line">    dbms_output.put_line(&apos;C_F_ID : &apos; || C_F_ID);</span><br><span class="line">    dbms_output.put_line(&apos;O_ACCESS_CODE : &apos; || O_ACCESS_CODE);</span><br><span class="line">    dbms_output.put_line(&apos;N_DEP_ID : &apos; || N_DEP_ID);</span><br><span class="line">    dbms_output.put_line(&apos;N_ACCESS_CODE : &apos; || N_ACCESS_CODE);</span><br><span class="line">    -- 更新该员工权限</span><br><span class="line">    EXECUTE IMMEDIATE C_UPDATE_USER USING N_ACCESS_CODE, N_DEP_ID, C_F_ID;</span><br><span class="line">    -- 更新所有该员工的客户的ACCESS权限</span><br><span class="line">    EXECUTE IMMEDIATE C_UPDATE_CUSTOMER USING N_ACCESS_CODE, C_F_ID;</span><br><span class="line">    -- 插入一条修改记录</span><br><span class="line">    EXECUTE IMMEDIATE C_INSERT_HISTORY USING USER_HISTORY.NEXTVAL, C_F_ID, O_DEP_ID, O_ACCESS_CODE, N_DEP_ID, N_ACCESS_CODE, SYSDATE;</span><br><span class="line">    -- 提交</span><br><span class="line">    COMMIT;</span><br><span class="line">  END;</span><br><span class="line">  /</span><br></pre></td></tr></table></figure>
<h4 id="创建序列"><a href="#创建序列" class="headerlink" title="创建序列"></a>创建序列</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 员工部门历史记录主码序列</span><br><span class="line">CREATE SEQUENCE USER_HISTORY INCREMENT BY 1 START WITH 1;</span><br></pre></td></tr></table></figure>
<h4 id="执行-2"><a href="#执行-2" class="headerlink" title="执行"></a>执行</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from t_customer_2 where f_access_code like &apos;xxx%&apos;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>xxx%</code>指匹配所有以<code>xxx</code>开头的权限码</p>
</blockquote>
<h4 id="当部门结构或员工归属调整时，权限编码如何处理？-1"><a href="#当部门结构或员工归属调整时，权限编码如何处理？-1" class="headerlink" title="当部门结构或员工归属调整时，权限编码如何处理？"></a>当部门结构或员工归属调整时，权限编码如何处理？</h4><p>方案二中，调用新增的过程<code>CHANGE_TO_DEPARTMENT</code>即可级联更改权限码。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/TimesTen/" rel="tag"># TimesTen</a>
              <a href="/tags/内存数据库/" rel="tag"># 内存数据库</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/11/12/使用Docker安装Oracle-12c/" rel="prev" title="感谢Docker,让我远离环境配置">
      <i class="fa fa-chevron-left"></i> 感谢Docker,让我远离环境配置
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/12/12/Hadoop-Tags/" rel="next" title="Hadoop-Tags">
      Hadoop-Tags <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Lesson-1"><span class="nav-number">1.</span> <span class="nav-text">Lesson 1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建用户并分配权限"><span class="nav-number">1.1.</span> <span class="nav-text">创建用户并分配权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建测试schema，命名为test"><span class="nav-number">1.1.1.</span> <span class="nav-text">创建测试schema，命名为test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分配连接资源"><span class="nav-number">1.1.2.</span> <span class="nav-text">分配连接资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为test用户创建external-data目录以及分配权限"><span class="nav-number">1.1.3.</span> <span class="nav-text">为test用户创建external_data目录以及分配权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分配表空间权限"><span class="nav-number">1.1.4.</span> <span class="nav-text">分配表空间权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接用户，建表，跑存储过程和函数"><span class="nav-number">1.2.</span> <span class="nav-text">连接用户，建表，跑存储过程和函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#连接test用户"><span class="nav-number">1.2.1.</span> <span class="nav-text">连接test用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建表"><span class="nav-number">1.2.2.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建ctl文件导入csv数据"><span class="nav-number">1.2.3.</span> <span class="nav-text">创建ctl文件导入csv数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据预处理"><span class="nav-number">1.3.</span> <span class="nav-text">数据预处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建函数和存储过程"><span class="nav-number">1.4.</span> <span class="nav-text">创建函数和存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#声明函数和存储过程"><span class="nav-number">1.4.1.</span> <span class="nav-text">声明函数和存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行函数和存储过程"><span class="nav-number">1.4.2.</span> <span class="nav-text">执行函数和存储过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结果分析"><span class="nav-number">1.5.</span> <span class="nav-text">结果分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lesson-2"><span class="nav-number">2.</span> <span class="nav-text">Lesson 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建用户并分配权限-1"><span class="nav-number">2.1.</span> <span class="nav-text">创建用户并分配权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建用户"><span class="nav-number">2.1.1.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分配权限"><span class="nav-number">2.1.2.</span> <span class="nav-text">分配权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建表及其他对象"><span class="nav-number">2.2.</span> <span class="nav-text">创建表及其他对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建表-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建索引、序列"><span class="nav-number">2.2.2.</span> <span class="nav-text">创建索引、序列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建触发器"><span class="nav-number">2.2.3.</span> <span class="nav-text">创建触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建过程"><span class="nav-number">2.2.4.</span> <span class="nav-text">创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#过程reset-seq"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">过程reset_seq</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过程init"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">过程init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改客户信息过程"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">修改客户信息过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行"><span class="nav-number">2.2.5.</span> <span class="nav-text">执行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lesson-3"><span class="nav-number">3.</span> <span class="nav-text">Lesson 3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建用户并分配权限-2"><span class="nav-number">3.1.</span> <span class="nav-text">创建用户并分配权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建用户-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分配权限-1"><span class="nav-number">3.1.2.</span> <span class="nav-text">分配权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建表及其他对象-1"><span class="nav-number">3.2.</span> <span class="nav-text">创建表及其他对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案一"><span class="nav-number">3.2.1.</span> <span class="nav-text">方案一</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建表-2"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建过程-1"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#初始化"><span class="nav-number">3.2.1.2.1.</span> <span class="nav-text">初始化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行-1"><span class="nav-number">3.2.1.3.</span> <span class="nav-text">执行</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#初始化-1"><span class="nav-number">3.2.1.3.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询自己的客户"><span class="nav-number">3.2.1.3.2.</span> <span class="nav-text">查询自己的客户</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询某领导下属人员的所有客户"><span class="nav-number">3.2.1.3.3.</span> <span class="nav-text">查询某领导下属人员的所有客户</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#当部门结构或员工归属调整时，权限编码如何处理？"><span class="nav-number">3.2.1.4.</span> <span class="nav-text">当部门结构或员工归属调整时，权限编码如何处理？</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案二"><span class="nav-number">3.2.2.</span> <span class="nav-text">方案二</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建表-3"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建过程-2"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#初始化-2"><span class="nav-number">3.2.2.2.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#将某员工调换到某部门"><span class="nav-number">3.2.2.2.2.</span> <span class="nav-text">将某员工调换到某部门</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建序列"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">创建序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行-2"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#当部门结构或员工归属调整时，权限编码如何处理？-1"><span class="nav-number">3.2.2.5.</span> <span class="nav-text">当部门结构或员工归属调整时，权限编码如何处理？</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rui"
      src="/images/favicon.png">
  <p class="site-author-name" itemprop="name">Rui</p>
  <div class="site-description" itemprop="description">我们梦中见！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ruitan" title="GitHub → https://github.com/ruitan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1063932362@qq.com" title="E-Mail → mailto:1063932362@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://guitoubing.top" title="https://guitoubing.top" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.7.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  















  

  

  

<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "http://blog.guitoubing.top/2018/11/24/Practice/",
            identifier: "2018/11/24/Practice/",
            title: "内存数据库 - Best Practice"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://guitoubing-top.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
